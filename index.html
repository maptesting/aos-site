<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AOS — AI Receptionist Prompt Pack (Free Builder)</title>

  <!-- SEO -->
  <meta name="description" content="Build your own AI Receptionist in 30 seconds — free. Generate prompts, workflows, and voice previews for any business.">
  <meta property="og:title" content="AOS — Free AI Receptionist Builder">
  <meta property="og:description" content="Generate a custom AI receptionist instantly — prompt, workflows, and voice demo included.">
  <meta property="og:image" content="https://yourdomain.com/og-preview.png">
  <meta property="og:type" content="website">
  <meta name="twitter:card" content="summary_large_image">

  <!-- Favicon -->
  <link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"><rect width="64" height="64" rx="12" fill="%23556dff"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-family="Arial" font-size="28" fill="white">A</text></svg>'>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com?plugins=forms,typography,aspect-ratio"></script>
  <script>
    window.tailwind = window.tailwind || {};
    window.tailwind.config = {
      theme: {
        extend: {
          colors: { 
            brand: {
              500: "#556dff", 
              600: "#3d4fe6"
            }, 
            ink: "#0b0f1a" 
          },
          boxShadow: { 
            soft: "0 8px 30px rgba(0,0,0,.18)" 
          }
        }
      }
    };
  </script>

  <style>
    body{ background:#0b0f1a; color:#fff }
    .gradient{
      background:
       radial-gradient(1200px 600px at 20% -10%, rgba(85,109,255,.25), transparent 60%),
       radial-gradient(1000px 600px at 100% 0%, rgba(34,42,130,.35), transparent 60%);
    }
    .glass{ backdrop-filter: blur(10px); background: rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.08) }
    .code{ white-space:pre-wrap; font-family: ui-monospace, Menlo, Consolas, monospace; font-size: 0.875rem; }
    input, textarea, select{
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.15);
      border-radius: 10px;
      padding: 0.75rem 1rem;
      color: #fff;
      font-size: 0.9375rem;
      transition: all 0.2s ease;
      width: 100%;
    }
    input::placeholder, textarea::placeholder{ 
      color: rgba(255,255,255,.4);
      font-size: 0.875rem;
    }
    input:focus, textarea:focus, select:focus{ 
      outline: none; 
      background: rgba(255,255,255,.12);
      border-color: rgba(85,109,255,.6);
      box-shadow: 0 0 0 3px rgba(85,109,255,.15);
    }
    input:hover, textarea:hover, select:hover{
      border-color: rgba(255,255,255,.25);
    }
    select {
      cursor: pointer;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23ffffff' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 1rem center;
      padding-right: 2.5rem;
    }
    textarea {
      resize: vertical;
      min-height: 80px;
      font-family: inherit;
      line-height: 1.5;
    }
    .range {appearance:none;height:6px;border-radius:9999px;background:linear-gradient(to right,#556dff var(--pct,0%),rgba(255,255,255,.2) 0)}
    .range::-webkit-slider-thumb{appearance:none;width:14px;height:14px;border-radius:9999px;background:#fff;border:2px solid #556dff;box-shadow:0 0 0 3px rgba(85,109,255,.25)}
    .btn-ghost{ background:transparent; border:1px solid rgba(255,255,255,.12) }
    .muted{ color: rgba(255,255,255,.65) }
    .hidden{ display:none }
    .field>label{ 
      font-size: 0.8125rem; 
      color: rgba(255,255,255,.85); 
      display: block; 
      margin-bottom: 0.5rem; 
      font-weight: 500;
      letter-spacing: 0.01em;
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="gradient border-b border-white/10">
    <div class="max-w-6xl mx-auto px-4 py-6 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-9 h-9 rounded-xl bg-brand-500 grid place-items-center text-black font-bold">A</div>
        <div>
          <div class="font-semibold">AOS</div>
          <div class="text-white/60 text-xs">AI Optimization Solutions</div>
        </div>
      </div>
      <nav class="flex items-center gap-2">
        <a href="#/" class="px-4 py-2 rounded-xl bg-white/10 hover:bg-white/15 transition">Home</a>
        <a href="#builder" class="px-4 py-2 rounded-xl bg-brand-500 hover:bg-brand-600 transition">Build Free</a>
      </nav>
    </div>
  </header>

  <!-- HOME VIEW -->
  <main id="view-home">
    <!-- Hero -->
    <section class="relative gradient overflow-hidden">
      <div class="mx-auto max-w-7xl px-4 pt-20 pb-16 md:pt-24 md:pb-24">
        <div class="grid md:grid-cols-2 gap-16 items-start">
          <!-- Left -->
          <div>
            <h1 class="text-4xl md:text-5xl font-extrabold leading-tight">
              AI Receptionist Prompt Pack — <span class="text-brand-500">Free Builder</span>
            </h1>
            <p class="mt-6 text-white/70 max-w-2xl leading-relaxed">
              Answer a few questions about your business. Get a production-ready System Prompt and
              download two <b>n8n</b> workflows — <em>checkAvailability</em> and <em>bookAppointment</em>.
            </p>
            <div class="mt-8">
              <a href="#builder" class="px-5 py-3 rounded-xl bg-brand-500 hover:bg-brand-600 transition">Start Building</a>
            </div>
          </div>

          <!-- Demo Chat -->
          <div class="glass rounded-2xl p-6 md:p-8 shadow-soft mt-6 md:mt-0">
            <div class="text-sm text-white/60 mb-2">Talk to Ava — Receptionist (Demo)</div>
            <div id="chatBox" class="h-64 overflow-y-auto bg-black/20 rounded-xl p-3 space-y-3 text-sm border border-white/10">
              <div class="flex gap-3">
                <div class="w-8 h-8 rounded-full bg-brand-500 grid place-items-center text-black font-bold flex-shrink-0">A</div>
                <div>Hi! This is Ava from BrightSmile Dental — how can I help you today?</div>
              </div>
            </div>
            <form id="chatForm" class="mt-3 flex gap-2" autocomplete="off">
              <input id="chatInput" type="text" placeholder="Type your message..." class="flex-1 bg-white/5 border border-white/10 rounded-xl px-3 py-2 text-sm" required>
              <button id="chatSend" type="submit" class="bg-brand-500 hover:bg-brand-600 transition rounded-xl px-4 py-2 text-sm font-medium">Send</button>
            </form>
          </div>
        </div>
      </div>
    </section>

    <!-- Builder -->
    <section id="builder" class="py-24 md:py-32 scroll-mt-28">
      <div class="max-w-6xl mx-auto px-4">
        <h2 class="text-center text-3xl font-bold mb-10 text-white">Build your AI Receptionist</h2>

        <div class="grid lg:grid-cols-2 gap-8">
          <!-- Form -->
          <div class="glass rounded-2xl p-6 md:p-8 shadow-soft">
            <h3 class="text-2xl font-semibold">Your Business</h3>
            <p class="text-white/60 text-sm mt-1">We'll generate a tailored prompt and n8n templates.</p>
            <form id="aiForm" class="grid gap-4 mt-6">
              <div class="grid md:grid-cols-2 gap-4">
                <div class="field">
                  <label>Business Name *</label>
                  <input name="bizName" placeholder="e.g., BrightSmile Dental" required>
                </div>
                <div class="field">
                  <label>Location / Service Area *</label>
                  <input name="location" placeholder="e.g., Charlotte, NC" required>
                </div>
              </div>

              <div class="grid md:grid-cols-2 gap-4">
                <div class="field">
                  <label>Industry *</label>
                  <input name="industry" placeholder="e.g., salon, rentals, clinic" required>
                </div>
                <div class="field">
                  <label>Services (comma-separated) *</label>
                  <input name="services" placeholder="Full detail, Interior only, Exterior only" required>
                </div>
              </div>

              <div class="grid md:grid-cols-3 gap-4">
                <div class="field">
                  <label>Agent Name</label>
                  <input name="agentName" placeholder="Alex" value="Alex">
                </div>
                <div class="field">
                  <label>Language</label>
                  <input name="language" placeholder="English" value="English">
                </div>
                <div class="field">
                  <label>Timezone</label>
                  <input name="timezone" placeholder="America/New_York">
                </div>
              </div>

              <div class="grid md:grid-cols-3 gap-4">
                <div class="field">
                  <label>Hours</label>
                  <input name="hours" placeholder="Mon–Sat 9–6">
                </div>
                <div class="field">
                  <label>Google Calendar ID</label>
                  <input name="calendarId" placeholder="primary">
                </div>
                <div class="field">
                  <label>Confirmation Email (from)</label>
                  <input name="email" type="email" placeholder="no-reply@yourbiz.com">
                </div>
              </div>

              <div class="field">
                <label>Policies / Deposits / Refunds (optional)</label>
                <textarea name="policies" rows="2" placeholder="Deposit $25 to secure slot. 24h reschedule window."></textarea>
              </div>

              <!-- Voice picker -->
              <div class="grid md:grid-cols-2 gap-4 items-end mt-2">
                <div class="field">
                  <label>Voice</label>
                  <select id="voiceSelect">
                    <option value="">Default</option>
                    <option value="56bWURjYFHyYyVf490Dp">Emma</option>
                    <option value="UgBBYS2sOqTuMpoF3BR0">Mark</option>
                  </select>
                </div>
                <div class="flex gap-3 flex-wrap">
                  <button type="button" id="previewBtn" class="px-4 py-3 rounded-xl bg-brand-500 hover:bg-brand-600 transition font-medium inline-flex items-center gap-2">
                    <span id="previewSpinner" class="hidden inline-block w-4 h-4 border-2 border-white/40 border-t-white rounded-full animate-spin"></span>
                    <span>Generate Preview</span>
                  </button>
                  <button type="button" id="ttsBtn" class="px-4 py-3 rounded-xl btn-ghost hover:bg-white/5 transition font-medium" disabled>Hear AI Greeting</button>
                </div>
              </div>
            </form>
          </div>

          <!-- Preview + downloads -->
          <div class="glass rounded-2xl p-6 md:p-8 shadow-soft">
            <h3 class="text-xl font-semibold">System Prompt — Preview</h3>
            <div class="text-xs text-white/60 mb-3">Preview only (truncated)</div>
            <div id="promptOut" class="code bg-black/30 rounded-xl p-4 border border-white/10 min-h-[280px] text-white/80"></div>

            <div class="mt-6">
              <h4 class="text-sm font-semibold text-white/80 mb-2">Downloads</h4>
              <div class="flex flex-wrap gap-2">
                <button id="downloadPromptBtn" class="px-4 py-2 rounded-xl bg-brand-500/80 hover:bg-brand-600 transition font-medium disabled:opacity-50 disabled:cursor-not-allowed" disabled>Download Full Prompt (.txt)</button>
                <button id="downloadAvailBtn" class="px-4 py-2 rounded-xl btn-ghost hover:bg-white/5 transition disabled:opacity-50 disabled:cursor-not-allowed" disabled>Download: checkAvailability.json</button>
                <button id="downloadBookBtn" class="px-4 py-2 rounded-xl btn-ghost hover:bg-white/5 transition disabled:opacity-50 disabled:cursor-not-allowed" disabled>Download: bookAppointment.json</button>
              </div>
              <div id="successMsg" class="hidden mt-3 text-sm text-green-400"></div>
              <p id="notice" class="mt-3 text-xs text-white/60"></p>
            </div>

            <!-- Audio Player -->
            <div class="mt-6">
              <audio id="audio" class="hidden"></audio>
              <div id="audioUI" class="hidden glass rounded-xl p-4">
                <div class="flex items-center gap-3">
                  <button id="audioPlay" class="w-10 h-10 rounded-full bg-brand-500 hover:bg-brand-600 transition grid place-items-center text-black font-bold">▶</button>
                  <div class="flex-1">
                    <input id="audioSeek" type="range" min="0" max="100" value="0" class="w-full range">
                    <div class="flex justify-between text-xs text-white/60 mt-1">
                      <span id="audioTime">0:00</span>
                      <span id="audioDur">0:00</span>
                    </div>
                  </div>
                  <a id="audioDownload" download="ai-greeting.mp3" class="text-sm underline decoration-blue-400 hover:text-blue-300 transition">Download</a>
                </div>
              </div>
            </div>
          </div>
        </div>

        <p class="text-center text-sm text-white/50 mt-8">
          After import, attach your Google Calendar OAuth2 and OpenAI credentials in n8n.
        </p>
      </div>
    </section>

    <!-- Agents -->
    <section id="agents" class="py-20 border-t border-white/10">
      <div class="max-w-6xl mx-auto px-4">
        <h2 class="text-3xl font-bold mb-6">More Plug-and-Play Agents</h2>
        <p class="muted mb-6">Each opens its own page to generate a tailored Full Prompt and n8n JSON.</p>

        <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4">
          <a href="#/agent/invoice" class="glass rounded-2xl p-5 block hover:bg-white/5 transition">
            <div class="text-lg font-semibold">AI Invoice / Follow-ups</div>
            <div class="text-sm text-white/70 mt-1">Generate invoices + reminders via email. Logs to Airtable.</div>
          </a>

          <a href="#/agent/salesCloser" class="glass rounded-2xl p-5 block hover:bg-white/5 transition">
            <div class="text-lg font-semibold">AI Sales Closer</div>
            <div class="text-sm text-white/70 mt-1">Objection-aware nudges via SMS/Email. Auto-logs follow-ups.</div>
          </a>

          <a href="#/agent/leadQualifier" class="glass rounded-2xl p-5 block hover:bg-white/5 transition">
            <div class="text-lg font-semibold">AI Lead Qualifier</div>
            <div class="text-sm text-white/70 mt-1">Score & route leads (A/B/C). Email both lead & owner.</div>
          </a>

          <a href="#/agent/dmResponder" class="glass rounded-2xl p-5 block hover:bg-white/5 transition">
            <div class="text-lg font-semibold">AI DM Responder</div>
            <div class="text-sm text-white/70 mt-1">Short replies for IG/TikTok that push to your CTA. Tags & logs.</div>
          </a>
        </div>
      </div>
    </section>

    <!-- Video -->
    <section class="py-16 border-t border-white/10">
      <div class="max-w-4xl mx-auto px-4">
        <h3 class="text-xl font-semibold mb-3">How to use this builder</h3>
        <div class="rounded-2xl overflow-hidden border border-white/10 shadow-soft aspect-video max-w-3xl mx-auto">
          <iframe
            class="w-full h-full"
            src="https://www.youtube.com/embed/Akwe5h3CQKo?si=Q-Uto-rIMjTar1vv"
            title="AOS — How to use the AI Receptionist Builder"
            frameborder="0"
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
            referrerpolicy="strict-origin-when-cross-origin"
            allowfullscreen></iframe>
        </div>
      </div>
    </section>
  </main>

  <!-- AGENT VIEW -->
  <main id="view-agent" class="hidden">
    <section class="py-10">
      <div class="max-w-5xl mx-auto px-4">
        <a href="#/" class="inline-flex items-center gap-2 text-white/80 hover:text-white mb-6 transition">← Back</a>
        <div class="glass rounded-2xl p-6 md:p-8">
          <h2 id="agentTitle" class="text-2xl font-bold"></h2>
          <p id="agentDesc" class="text-white/70 mt-2"></p>

          <form id="agentForm" class="grid gap-4 mt-6"></form>

          <div class="mt-6">
            <div class="flex flex-wrap gap-2">
              <button id="agentGenerate" class="px-4 py-2 rounded-xl bg-brand-500 hover:bg-brand-600 transition font-medium">Generate</button>
              <a id="agentPromptDownload" class="px-4 py-2 rounded-xl btn-ghost hover:bg-white/5 transition cursor-pointer">Download Full Prompt (.txt)</a>
              <a id="agentJsonDownload" class="px-4 py-2 rounded-xl btn-ghost hover:bg-white/5 transition cursor-pointer">Download n8n JSON</a>
            </div>
            <div id="agentMsg" class="text-xs text-green-400 mt-3 hidden">Generated ✓</div>

            <h4 class="mt-6 font-semibold">Prompt Preview</h4>
            <div id="agentPromptPreview" class="code bg-black/30 rounded-xl p-4 border border-white/10 min-h-[180px] mt-2 text-white/80"></div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <footer class="py-10 text-center text-white/40 text-sm border-t border-white/10">
    © <span id="year"></span> AOS — AI Optimization Solutions
  </footer>

  <!-- WORKFLOW TEMPLATES - FIXED VERSIONS -->
  <script id="tplCheckAvailability" type="application/json">
{
  "name": "checkAvailability",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "{{WEBHOOK_PATH_CHECK}}",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [240, 300],
      "id": "webhook-node",
      "name": "Webhook",
      "webhookId": "{{WEBHOOK_ID_CHECK}}"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{$json.body.systemPrompt || 'You are an appointment availability checker.'}}",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2.2,
      "position": [560, 300],
      "id": "ai-agent",
      "name": "AI Agent"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "mode": "list",
          "value": "gpt-4o-mini"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [560, 500],
      "id": "openai-model",
      "name": "OpenAI Chat Model"
    },
    {
      "parameters": {
        "resource": "calendar",
        "calendar": {
          "__rl": true,
          "value": "{{CALENDAR_ID}}",
          "mode": "list",
          "cachedResultName": "{{CALENDAR_ID}}"
        },
        "timeMin": "={{ $json.body.requestedTime || $now.toISO() }}",
        "timeMax": "={{ $json.body.requestedTimeEnd || $now.plus({ hours: 24 }).toISO() }}",
        "options": {}
      },
      "type": "n8n-nodes-base.googleCalendarTool",
      "typeVersion": 1.3,
      "position": [760, 500],
      "id": "calendar-tool",
      "name": "Check Availability Tool"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={\n  \"success\": true,\n  \"message\": {{ $json.output ? JSON.stringify($json.output) : '\"Availability checked\"' }},\n  \"availableSlots\": {{ $json.availableSlots ? JSON.stringify($json.availableSlots) : '[]' }}\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [960, 300],
      "id": "respond-webhook",
      "name": "Respond to Webhook"
    }
  ],
  "connections": {
    "Webhook": {
      "main": [
        [
          {
            "node": "AI Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent": {
      "main": [
        [
          {
            "node": "Respond to Webhook",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Create Calendar Event Tool": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Send Confirmation Email": {
      "main": [
        [
          {
            "node": "Respond to Webhook",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1",
    "timezone": "{{TIMEZONE}}"
  }
}
  </script>

  <!-- AGENT PROMPTS -->
  <script id="prInvoice" type="text/plain">
You are {{AGENT_NAME}}, an invoice/follow-up assistant for {{BIZ_NAME}}.
Task: when provided a customer + line items, generate a clear, friendly invoice email with due date, payment link, and gentle follow-ups if overdue.

Must collect/accept:
- client name, email
- line items as [{desc, qty, unitPrice}] and compute totals
- taxes/fees per {{TAX_RULES_SNIPPET}} if provided
- terms, due date, payment link {{PAYMENT_LINK}}
- business contact {{BIZ_EMAIL}}

Tone: professional, 2–4 short sentences, no fluff.

OUTPUT JSON ONLY (no prose):
{ "intent":"invoice" | "reminder",
  "toEmail":"", "subject":"", "textBody":"",
  "total": number, "dueISO":"", "paymentLink":"{{PAYMENT_LINK}}"
}
If input suggests a reminder (overdue), set intent to "reminder" and adjust tone slightly firmer but polite.
  </script>

  <script id="prSalesCloser" type="text/plain">
You are {{AGENT_NAME}}, a sales closer for {{BIZ_NAME}}.
Goal: convert warm leads to a booked call or paid order.

Context inputs: lead name, last interaction, offer {{OFFER_SNIPPET}}, CTA {{CTA_URL}}.
Strategy:
- If no reply: send Nudge A, then Nudge B after {{FOLLOWUP_GAP_HOURS}} hours.
- If objection (price/timing/fit), answer briefly with one strong benefit and exactly one CTA link.
- If ready, ask for a call time (2 slots) or link directly to checkout.

OUTPUT JSON ONLY:
{ "to":"", "channel":"sms|email", "subject":"", "textBody":"", "nextFollowupHours": {{FOLLOWUP_GAP_HOURS}}, "stage":"A|B|Close" }
Keep copy short and human. No emojis unless the lead uses them.
  </script>

  <script id="prLeadQualifier" type="text/plain">
You are {{AGENT_NAME}}, a lead qualifier for {{BIZ_NAME}}.
Qualify leads and route them according to {{QUAL_RULES}}.

Collect or use:
name, email, phone, company, budget, timeline, service need, location.

OUTPUT JSON ONLY:
{ "score": 0-100, "tier":"A|B|C", "reason":"", "recommendedNext":"book_call|nurture|reject",
  "emailToLead": {"subject":"","textBody":""},
  "emailToOwner": {"subject":"","textBody":""}
}
Terse, friendly, zero fluff. Reasons should be one sentence.
  </script>

  <script id="prDMResponder" type="text/plain">
You are {{AGENT_NAME}}, a DM responder for {{BIZ_NAME}}.
Reply to IG/TikTok DMs with short, human messages that move users to {{PRIMARY_CTA}} (link: {{BOOK_URL}}).
If complex product questions arise, answer briefly and point to {{FAQ_URL}}.

OUTPUT JSON ONLY:
{"reply":"", "suggestedTag":"lead|customer|spam"}

One or two lines max. No emojis unless user uses them first.
  </script>

  <!-- AGENT WORKFLOW TEMPLATES -->
  <script id="tplAgentInvoice" type="application/json">
{
  "name": "AI Invoice & Follow-ups",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "invoice-handler",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "webhook-invoice",
      "name": "Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [240, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.openai.com/v1/chat/completions",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "openAiApi",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"model\": \"{{OPENAI_MODEL}}\",\n  \"messages\": [\n    {\n      \"role\": \"system\",\n      \"content\": \"YOU_ARE_INVOICE_ASSISTANT\"\n    },\n    {\n      \"role\": \"user\",\n      \"content\": {{ JSON.stringify($json.body) }}\n    }\n  ],\n  \"temperature\": 0.3\n}",
        "options": {}
      },
      "id": "openai-invoice",
      "name": "OpenAI Invoice Generator",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [560, 300]
    },
    {
      "parameters": {
        "jsCode": "const response = $input.item.json;\nconst content = response.choices?.[0]?.message?.content || '';\n\nlet parsed;\ntry {\n  parsed = JSON.parse(content);\n} catch (e) {\n  parsed = {\n    intent: 'invoice',\n    toEmail: '',\n    subject: 'Invoice',\n    textBody: content,\n    total: 0,\n    dueISO: new Date().toISOString(),\n    paymentLink: '{{PAYMENT_LINK}}'\n  };\n}\n\nreturn { json: parsed };"
      },
      "id": "parse-invoice",
      "name": "Parse Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [780, 300]
    },
    {
      "parameters": {
        "fromEmail": "{{SMTP_FROM}}",
        "toEmail": "={{ $json.toEmail }}",
        "subject": "={{ $json.subject }}",
        "emailType": "text",
        "message": "={{ $json.textBody }}",
        "options": {}
      },
      "id": "send-invoice-email",
      "name": "Send Email",
      "type": "n8n-nodes-base.emailSend",
      "typeVersion": 2.1,
      "position": [1000, 200]
    },
    {
      "parameters": {
        "operation": "append",
        "baseId": "={{AIRTABLE_BASE_ID}}",
        "tableId": "={{AIRTABLE_TABLE}}",
        "options": {},
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "Client",
              "fieldValue": "={{ $json.toEmail }}"
            },
            {
              "fieldId": "Total",
              "fieldValue": "={{ $json.total }}"
            },
            {
              "fieldId": "DueDate",
              "fieldValue": "={{ $json.dueISO }}"
            },
            {
              "fieldId": "Status",
              "fieldValue": "={{ $json.intent }}"
            }
          ]
        }
      },
      "id": "log-invoice",
      "name": "Log to Airtable",
      "type": "n8n-nodes-base.airtable",
      "typeVersion": 2,
      "position": [1000, 400]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json }}",
        "options": {}
      },
      "id": "respond-invoice",
      "name": "Respond",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [1220, 300]
    }
  ],
  "connections": {
    "Webhook": {
      "main": [
        [
          {
            "node": "OpenAI Invoice Generator",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Invoice Generator": {
      "main": [
        [
          {
            "node": "Parse Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Response": {
      "main": [
        [
          {
            "node": "Send Email",
            "type": "main",
            "index": 0
          },
          {
            "node": "Log to Airtable",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Email": {
      "main": [
        [
          {
            "node": "Respond",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Log to Airtable": {
      "main": [
        [
          {
            "node": "Respond",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  }
}
  </script>

  <script id="tplAgentSalesCloser" type="application/json">
{
  "name": "AI Sales Closer",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "sales-closer",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "webhook-sales",
      "name": "Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [240, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.openai.com/v1/chat/completions",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "openAiApi",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"model\": \"{{OPENAI_MODEL}}\",\n  \"messages\": [\n    {\n      \"role\": \"system\",\n      \"content\": \"YOU_ARE_SALES_CLOSER\"\n    },\n    {\n      \"role\": \"user\",\n      \"content\": {{ JSON.stringify($json.body) }}\n    }\n  ],\n  \"temperature\": 0.4\n}",
        "options": {}
      },
      "id": "openai-sales",
      "name": "OpenAI Sales Reply",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [560, 300]
    },
    {
      "parameters": {
        "jsCode": "const response = $input.item.json;\nconst content = response.choices?.[0]?.message?.content || '';\n\nlet parsed;\ntry {\n  parsed = JSON.parse(content);\n} catch (e) {\n  parsed = {\n    to: '',\n    channel: 'email',\n    subject: 'Follow up',\n    textBody: content,\n    nextFollowupHours: 24,\n    stage: 'A'\n  };\n}\n\nreturn { json: parsed };"
      },
      "id": "parse-sales",
      "name": "Parse Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [780, 300]
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{ $json.channel }}",
              "operation": "equals",
              "value2": "sms"
            }
          ]
        }
      },
      "id": "if-sms",
      "name": "If SMS",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [1000, 300]
    },
    {
      "parameters": {
        "fromEmail": "{{SMTP_FROM}}",
        "toEmail": "={{ $json.to }}",
        "subject": "={{ $json.subject }}",
        "emailType": "text",
        "message": "={{ $json.textBody }}",
        "options": {}
      },
      "id": "send-email-sales",
      "name": "Send Email",
      "type": "n8n-nodes-base.emailSend",
      "typeVersion": 2.1,
      "position": [1220, 400]
    },
    {
      "parameters": {
        "operation": "append",
        "baseId": "={{AIRTABLE_BASE_ID}}",
        "tableId": "={{AIRTABLE_TABLE}}",
        "options": {},
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "To",
              "fieldValue": "={{ $json.to }}"
            },
            {
              "fieldId": "Channel",
              "fieldValue": "={{ $json.channel }}"
            },
            {
              "fieldId": "Stage",
              "fieldValue": "={{ $json.stage }}"
            }
          ]
        }
      },
      "id": "log-sales",
      "name": "Log to Airtable",
      "type": "n8n-nodes-base.airtable",
      "typeVersion": 2,
      "position": [1440, 300]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json }}",
        "options": {}
      },
      "id": "respond-sales",
      "name": "Respond",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [1660, 300]
    }
  ],
  "connections": {
    "Webhook": {
      "main": [
        [
          {
            "node": "OpenAI Sales Reply",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Sales Reply": {
      "main": [
        [
          {
            "node": "Parse Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Response": {
      "main": [
        [
          {
            "node": "If SMS",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If SMS": {
      "main": [
        [
          {
            "node": "Log to Airtable",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Email",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Email": {
      "main": [
        [
          {
            "node": "Log to Airtable",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Log to Airtable": {
      "main": [
        [
          {
            "node": "Respond",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  }
}
  </script>

  <script id="tplAgentLeadQualifier" type="application/json">
{
  "name": "AI Lead Qualifier",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "lead-qualifier",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "webhook-lead",
      "name": "Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [240, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.openai.com/v1/chat/completions",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "openAiApi",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"model\": \"{{OPENAI_MODEL}}\",\n  \"messages\": [\n    {\n      \"role\": \"system\",\n      \"content\": \"YOU_ARE_LEAD_QUALIFIER\"\n    },\n    {\n      \"role\": \"user\",\n      \"content\": {{ JSON.stringify($json.body) }}\n    }\n  ],\n  \"temperature\": 0.2\n}",
        "options": {}
      },
      "id": "openai-lead",
      "name": "OpenAI Qualify Lead",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [560, 300]
    },
    {
      "parameters": {
        "jsCode": "const response = $input.item.json;\nconst content = response.choices?.[0]?.message?.content || '';\n\nlet parsed;\ntry {\n  parsed = JSON.parse(content);\n} catch (e) {\n  parsed = {\n    score: 50,\n    tier: 'B',\n    reason: content,\n    recommendedNext: 'nurture',\n    emailToLead: { subject: '', textBody: '' },\n    emailToOwner: { subject: '', textBody: '' }\n  };\n}\n\nreturn { json: parsed };"
      },
      "id": "parse-lead",
      "name": "Parse Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [780, 300]
    },
    {
      "parameters": {
        "fromEmail": "{{SMTP_FROM}}",
        "toEmail": "={{ $json.lead?.email || $json.emailToLead?.to || '' }}",
        "subject": "={{ $json.emailToLead.subject }}",
        "emailType": "text",
        "message": "={{ $json.emailToLead.textBody }}",
        "options": {}
      },
      "id": "email-lead",
      "name": "Email Lead",
      "type": "n8n-nodes-base.emailSend",
      "typeVersion": 2.1,
      "position": [1000, 200]
    },
    {
      "parameters": {
        "fromEmail": "{{SMTP_FROM}}",
        "toEmail": "{{BIZ_EMAIL}}",
        "subject": "={{ $json.emailToOwner.subject }}",
        "emailType": "text",
        "message": "={{ $json.emailToOwner.textBody }}",
        "options": {}
      },
      "id": "email-owner",
      "name": "Email Owner",
      "type": "n8n-nodes-base.emailSend",
      "typeVersion": 2.1,
      "position": [1000, 300]
    },
    {
      "parameters": {
        "operation": "append",
        "baseId": "={{AIRTABLE_BASE_ID}}",
        "tableId": "={{AIRTABLE_TABLE}}",
        "options": {},
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "Score",
              "fieldValue": "={{ $json.score }}"
            },
            {
              "fieldId": "Tier",
              "fieldValue": "={{ $json.tier }}"
            },
            {
              "fieldId": "Reason",
              "fieldValue": "={{ $json.reason }}"
            },
            {
              "fieldId": "Next",
              "fieldValue": "={{ $json.recommendedNext }}"
            }
          ]
        }
      },
      "id": "log-lead",
      "name": "Log to Airtable",
      "type": "n8n-nodes-base.airtable",
      "typeVersion": 2,
      "position": [1000, 400]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json }}",
        "options": {}
      },
      "id": "respond-lead",
      "name": "Respond",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [1220, 300]
    }
  ],
  "connections": {
    "Webhook": {
      "main": [
        [
          {
            "node": "OpenAI Qualify Lead",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Qualify Lead": {
      "main": [
        [
          {
            "node": "Parse Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Response": {
      "main": [
        [
          {
            "node": "Email Lead",
            "type": "main",
            "index": 0
          },
          {
            "node": "Email Owner",
            "type": "main",
            "index": 0
          },
          {
            "node": "Log to Airtable",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Email Lead": {
      "main": [
        [
          {
            "node": "Respond",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Email Owner": {
      "main": [
        [
          {
            "node": "Respond",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Log to Airtable": {
      "main": [
        [
          {
            "node": "Respond",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  }
}
  </script>

  <script id="tplAgentDMResponder" type="application/json">
{
  "name": "AI DM Responder",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "dm-responder",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "webhook-dm",
      "name": "Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [240, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.openai.com/v1/chat/completions",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "openAiApi",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"model\": \"{{OPENAI_MODEL}}\",\n  \"messages\": [\n    {\n      \"role\": \"system\",\n      \"content\": \"YOU_ARE_DM_RESPONDER\"\n    },\n    {\n      \"role\": \"user\",\n      \"content\": {{ JSON.stringify($json.body) }}\n    }\n  ],\n  \"temperature\": 0.5\n}",
        "options": {}
      },
      "id": "openai-dm",
      "name": "OpenAI DM Reply",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [560, 300]
    },
    {
      "parameters": {
        "jsCode": "const response = $input.item.json;\nconst content = response.choices?.[0]?.message?.content || '';\n\nlet parsed;\ntry {\n  parsed = JSON.parse(content);\n} catch (e) {\n  parsed = {\n    reply: content,\n    suggestedTag: 'lead'\n  };\n}\n\nreturn { json: parsed };"
      },
      "id": "parse-dm",
      "name": "Parse Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [780, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{PLATFORM_REPLY_WEBHOOK}}",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"conversationId\": {{ $json.conversationId ? JSON.stringify($json.conversationId) : '\"\"' }},\n  \"reply\": {{ JSON.stringify($json.reply) }}\n}",
        "options": {}
      },
      "id": "send-dm-reply",
      "name": "Send Reply to Platform",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1000, 200]
    },
    {
      "parameters": {
        "operation": "append",
        "baseId": "={{AIRTABLE_BASE_ID}}",
        "tableId": "={{AIRTABLE_TABLE}}",
        "options": {},
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "ConversationId",
              "fieldValue": "={{ $json.conversationId }}"
            },
            {
              "fieldId": "Reply",
              "fieldValue": "={{ $json.reply }}"
            },
            {
              "fieldId": "Tag",
              "fieldValue": "={{ $json.suggestedTag }}"
            }
          ]
        }
      },
      "id": "log-dm",
      "name": "Log to Airtable",
      "type": "n8n-nodes-base.airtable",
      "typeVersion": 2,
      "position": [1000, 400]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json }}",
        "options": {}
      },
      "id": "respond-dm",
      "name": "Respond",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [1220, 300]
    }
  ],
  "connections": {
    "Webhook": {
      "main": [
        [
          {
            "node": "OpenAI DM Reply",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI DM Reply": {
      "main": [
        [
          {
            "node": "Parse Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Response": {
      "main": [
        [
          {
            "node": "Send Reply to Platform",
            "type": "main",
            "index": 0
          },
          {
            "node": "Log to Airtable",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Reply to Platform": {
      "main": [
        [
          {
            "node": "Respond",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Log to Airtable": {
      "main": [
        [
          {
            "node": "Respond",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  }
}
  </script>

  <!-- MAIN JAVASCRIPT -->
  <script>
  (function(){
    'use strict';
    
    const $ = (id) => document.getElementById(id);
    const escapeHtml = (s) => (s || '').replace(/[&<>"']/g, m => ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", "\"": "&quot;", "'": "&#39;" }[m]));

    /* ============ DEMO CHAT ============ */
    function addMsg(role, text) {
      const wrap = $('chatBox');
      if (!wrap) return;
      
      const row = document.createElement('div');
      row.className = 'flex gap-3' + (role === 'user' ? ' justify-end' : '');
      
      if (role === 'user') {
        row.innerHTML = `<div class="max-w-[75%] bg-brand-500/20 rounded-xl px-3 py-2">${escapeHtml(text)}</div>`;
      } else {
        row.innerHTML = `
          <div class="w-8 h-8 rounded-full bg-brand-500 grid place-items-center text-black font-bold flex-shrink-0">A</div>
          <div class="max-w-[75%] bg-white/5 rounded-xl px-3 py-2">${escapeHtml(text)}</div>
        `;
      }
      
      wrap.appendChild(row);
      wrap.scrollTop = wrap.scrollHeight;
    }

    function initChat() {
      const form = $('chatForm');
      const input = $('chatInput');
      
      if (!form || !input) return;
      
      form.addEventListener('submit', (e) => {
        e.preventDefault();
        const text = input.value.trim();
        if (!text) return;
        
        addMsg('user', text);
        input.value = '';
        
        setTimeout(() => {
          addMsg('bot', "Thanks! (Demo only) — the real receptionist runs in your n8n workflows.");
        }, 400);
      });
    }

    /* ============ RECEPTIONIST FORM ============ */
    function getFormValues() {
      const form = $('aiForm');
      if (!form) return {};
      
      const values = Object.fromEntries(new FormData(form).entries());
      
      // Auto-detect timezone if not provided
      try {
        values.timezone = values.timezone || Intl.DateTimeFormat().resolvedOptions().timeZone || 'America/New_York';
      } catch (e) {
        values.timezone = values.timezone || 'America/New_York';
      }
      
      values.agentName = values.agentName || 'Alex';
      values.language = values.language || 'English';
      
      return values;
    }

    function truncate(str, maxLen = 1200) {
      if (!str) return '';
      return str.length > maxLen ? str.slice(0, maxLen) + ' …' : str;
    }

    function buildPrompt(values = {}) {
      const tz = values.timezone || 'America/New_York';
      const biz = values.bizName || 'the business';
      const agent = values.agentName || 'Alex';
      const industry = values.industry || 'services';
      const services = values.services || 'General services';
      const hours = values.hours || 'Mon–Fri 9:00–17:00';
      const location = values.location || 'Local area';
      const policies = values.policies || 'Standard policies apply.';
      const emailFrom = values.email || 'no-reply@example.com';
      
      let now;
      try {
        now = new Date().toLocaleString('en-US', {
          timeZone: tz,
          weekday: 'long',
          year: 'numeric',
          month: 'long',
          day: '2-digit',
          hour: '2-digit',
          minute: '2-digit'
        });
      } catch (e) {
        now = new Date().toLocaleString();
      }

      return `# ROLE
You are ${agent}, a friendly, efficient AI receptionist for **${biz}** (${industry}). Keep replies to 1–2 sentences, natural and clear.

# CURRENT TIME
- Current time: **${now}**
- Timezone: **${tz}**
Use ISO 8601 timestamps when interacting with tools.

# BUSINESS CONTEXT
Business: ${biz}
Location / Service: ${location}
Industry: ${industry}
Services: ${services}
Hours: ${hours}
Policies: ${policies}

# TASK
Answer questions and help book appointments quickly.

# BOOKING FLOW
1) Ask for the preferred date/time (within ${hours}).
2) Check the requested slot.
3) If unavailable, propose up to 3 close alternatives (same day or next business day).
4) Collect full name, email, phone.
5) Confirm slot and create the booking.
6) Summarize details and say a confirmation will be sent from **${emailFrom}**.

# STYLE & RULES
Warm, concise, confident; use contractions. Don't invent availability outside ${hours}. Confirm final date/time + contact details.`;
    }

    /* ============ DOWNLOADS ============ */
    function flashSuccess(msg) {
      const el = $('successMsg');
      if (!el) return;
      
      el.textContent = msg;
      el.classList.remove('hidden');
      
      clearTimeout(el._timeout);
      el._timeout = setTimeout(() => el.classList.add('hidden'), 2000);
    }

    function downloadFile(filename, content, mimeType = 'text/plain') {
      const blob = new Blob([content], { type: mimeType });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      a.click();
      URL.revokeObjectURL(url);
    }

    function enablePromptDownload() {
      const btn = $('downloadPromptBtn');
      if (!btn) return;
      
      btn.disabled = false;
      btn.onclick = (e) => {
        e.preventDefault();
        const values = getFormValues();
        const prompt = buildPrompt(values);
        const filename = `${(values.bizName || 'AI_Receptionist').replace(/[^a-z0-9]/gi, '_')}_prompt.txt`;
        downloadFile(filename, prompt, 'text/plain');
        flashSuccess('Prompt downloaded ✓');
      };
    }

    /* ============ JSON WORKFLOW GENERATION ============ */
    function readTemplate(id) {
      const el = $(id);
      if (!el) {
        const notice = $('notice');
        if (notice) notice.textContent = `Template "${id}" is missing.`;
        throw new Error('Missing template: ' + id);
      }
      
      const text = el.textContent || '';
      if (!text.trim()) {
        const notice = $('notice');
        if (notice) notice.textContent = `Template "${id}" is empty.`;
        throw new Error('Empty template: ' + id);
      }
      
      try {
        return JSON.parse(text);
      } catch (e) {
        throw new Error(`Failed to parse template "${id}": ${e.message}`);
      }
    }

    function slugify(str) {
      return (str || '')
        .toLowerCase()
        .replace(/[^a-z0-9]+/g, '-')
        .replace(/^-+|-+$/g, '')
        .slice(0, 48) || 'biz';
    }

    function generateUniqueId() {
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, (c) => {
        const r = (Math.random() * 16) | 0;
        const v = c === 'x' ? r : (r & 0x3) | 0x8;
        return v.toString(16);
      });
    }

    function injectPlaceholders(str, map) {
      let result = str;
      Object.entries(map).forEach(([key, value]) => {
        const placeholder = `{{${key}}}`;
        result = result.split(placeholder).join(String(value ?? ''));
      });
      return result;
    }

    function renderWorkflow(templateId, values, type) {
      const workflow = readTemplate(templateId);
      const base = 'aos-' + slugify(values.bizName);
      
      const map = {
        WEBHOOK_PATH_CHECK: `${base}-check`,
        WEBHOOK_PATH_BOOK: `${base}-book`,
        WEBHOOK_ID_CHECK: generateUniqueId(),
        WEBHOOK_ID_BOOK: generateUniqueId(),
        CALENDAR_ID: values.calendarId || 'primary',
        TIMEZONE: values.timezone || 'America/New_York',
        BIZ_NAME: values.bizName || 'Business',
        CONFIRMATION_EMAIL: values.email || 'no-reply@example.com'
      };
      
      // Set timezone in settings
      if (workflow.settings) {
        workflow.settings.timezone = map.TIMEZONE;
      }
      
      // Inject placeholders
      let workflowStr = JSON.stringify(workflow, null, 2);
      workflowStr = injectPlaceholders(workflowStr, map);
      
      return workflowStr;
    }

    function enableWorkflowDownload(btnId, templateId, values, type, filename) {
      const btn = $(btnId);
      if (!btn) return;
      
      btn.disabled = false;
      btn.onclick = (e) => {
        e.preventDefault();
        try {
          const json = renderWorkflow(templateId, values, type);
          downloadFile(filename, json, 'application/json');
          flashSuccess(`${filename} downloaded ✓`);
        } catch (err) {
          console.error(err);
          alert('Download failed: ' + err.message);
        }
      };
    }

    /* ============ PREVIEW GENERATION ============ */
    async function generatePreview() {
      const btn = $('previewBtn');
      const spinner = $('previewSpinner');
      const output = $('promptOut');
      const notice = $('notice');
      const ttsBtn = $('ttsBtn');
      
      if (!btn || !output) return;
      
      btn.disabled = true;
      if (spinner) spinner.classList.remove('hidden');
      
      try {
        const values = getFormValues();
        const prompt = buildPrompt(values);
        
        // Show truncated preview
        output.textContent = truncate(prompt, 1200);
        
        // Enable downloads
        enablePromptDownload();
        enableWorkflowDownload('downloadAvailBtn', 'tplCheckAvailability', values, 'check', 'checkAvailability.json');
        enableWorkflowDownload('downloadBookBtn', 'tplBookAppointment', values, 'book', 'bookAppointment.json');
        
        if (notice) {
          notice.textContent = 'Downloads ready. JSONs customized with your Calendar ID, Timezone, and unique webhook paths.';
        }
        
        // Enable TTS button
        if (ttsBtn) ttsBtn.disabled = false;
        
      } catch (err) {
        console.error(err);
        alert('Error generating preview: ' + err.message);
      } finally {
        if (spinner) spinner.classList.add('hidden');
        btn.disabled = false;
      }
    }

    /* ============ AUDIO PLAYER ============ */
    function formatTime(seconds) {
      seconds = Math.max(0, seconds | 0);
      const m = (seconds / 60) | 0;
      const s = seconds % 60;
      return m + ':' + (s < 10 ? '0' : '') + s;
    }

    function initAudioPlayer() {
      const audio = $('audio');
      const ui = $('audioUI');
      const playBtn = $('audioPlay');
      const seek = $('audioSeek');
      const timeEl = $('audioTime');
      const durEl = $('audioDur');
      
      if (!audio || !ui) return;
      
      function updateUI() {
        if (!isFinite(audio.duration)) return;
        
        durEl.textContent = formatTime(audio.duration);
        timeEl.textContent = formatTime(audio.currentTime);
        
        const pct = (audio.currentTime / Math.max(1, audio.duration)) * 100;
        seek.value = pct;
        seek.style.setProperty('--pct', pct + '%');
        playBtn.textContent = audio.paused ? '▶' : '⏸';
      }
      
      playBtn.addEventListener('click', () => {
        audio.paused ? audio.play() : audio.pause();
      });
      
      audio.addEventListener('play', updateUI);
      audio.addEventListener('pause', updateUI);
      audio.addEventListener('timeupdate', updateUI);
      audio.addEventListener('loadedmetadata', () => {
        ui.classList.remove('hidden');
        updateUI();
      });
      
      seek.addEventListener('input', () => {
        const pct = parseFloat(seek.value || '0') / 100;
        if (isFinite(audio.duration)) {
          audio.currentTime = audio.duration * pct;
        }
        seek.style.setProperty('--pct', seek.value + '%');
      });
    }

    /* ============ TEXT-TO-SPEECH ============ */
    async function generateTTS() {
      const ttsBtn = $('ttsBtn');
      if (ttsBtn) ttsBtn.disabled = true;
      
      try {
        const values = getFormValues();
        const voiceId = $('voiceSelect')?.value || '';
        const text = `Hey, this is ${values.agentName || 'Alex'} with ${values.bizName || 'your business'}. How can I help you today?`;
        
        // This is a placeholder - you'd need to implement your TTS API endpoint
        // For now, we'll just show a message
        alert('TTS feature requires backend API integration. The greeting would be: "' + text + '"');
        
      } catch (err) {
        console.error(err);
        alert('TTS failed: ' + err.message);
      } finally {
        if (ttsBtn) ttsBtn.disabled = false;
      }
    }

    /* ============ AGENT SYSTEM ============ */
    const AGENTS = {
      invoice: {
        title: 'AI Invoice / Follow-ups',
        desc: 'Generate invoices + polite reminders and email them. Logs to Airtable.',
        promptId: 'prInvoice',
        tplId: 'tplAgentInvoice',
        fields: [
          { name: 'bizName', label: 'Business Name', required: true },
          { name: 'agentName', label: 'Agent Name', value: 'Ava' },
          { name: 'email', label: 'Business Email (from)', required: true },
          { name: 'timezone', label: 'Timezone', value: 'America/New_York' },
          { name: 'openaiModel', label: 'OpenAI Model', value: 'gpt-4o-mini' },
          { name: 'paymentLink', label: 'Payment Link (Stripe/PayPal)', required: true },
          { name: 'taxRules', label: 'Tax Rules (optional)' },
          { name: 'airtableBaseId', label: 'Airtable Base ID' },
          { name: 'airtableTable', label: 'Airtable Table', value: 'Invoices' },
          { name: 'airtableCredId', label: 'Airtable Credential ID' },
          { name: 'smtpFrom', label: 'SMTP From (no-reply@...)' },
          { name: 'smtpCredId', label: 'SMTP Credential ID' }
        ],
        map: (v) => ({
          BIZ_NAME: v.bizName,
          AGENT_NAME: v.agentName,
          BIZ_EMAIL: v.email,
          TIMEZONE: v.timezone,
          OPENAI_MODEL: v.openaiModel,
          PAYMENT_LINK: v.paymentLink,
          TAX_RULES_SNIPPET: v.taxRules || '',
          AIRTABLE_BASE_ID: v.airtableBaseId || '',
          AIRTABLE_TABLE: v.airtableTable || 'Logs',
          AIRTABLE_CRED_ID: v.airtableCredId || '',
          SMTP_FROM: v.smtpFrom || 'no-reply@example.com',
          SMTP_CRED_ID: v.smtpCredId || 'SMTP_CREDENTIAL'
        }),
        fileBase: 'invoice'
      },
      salesCloser: {
        title: 'AI Sales Closer',
        desc: 'Objection-aware nudges via SMS/Email. Auto-logs follow-ups.',
        promptId: 'prSalesCloser',
        tplId: 'tplAgentSalesCloser',
        fields: [
          { name: 'bizName', label: 'Business Name', required: true },
          { name: 'agentName', label: 'Agent Name', value: 'Ava' },
          { name: 'email', label: 'Business Email (from)', required: true },
          { name: 'openaiModel', label: 'OpenAI Model', value: 'gpt-4o-mini' },
          { name: 'offerSnippet', label: 'Offer Snippet', required: true },
          { name: 'ctaUrl', label: 'CTA URL (checkout/booking)', required: true },
          { name: 'followupGap', label: 'Follow-up Gap (hours)', value: '24' },
          { name: 'airtableBaseId', label: 'Airtable Base ID' },
          { name: 'airtableTable', label: 'Airtable Table', value: 'Sales' },
          { name: 'airtableCredId', label: 'Airtable Credential ID' },
          { name: 'smtpFrom', label: 'SMTP From (no-reply@...)' },
          { name: 'smtpCredId', label: 'SMTP Credential ID' },
          { name: 'twilioFrom', label: 'Twilio From +1...' },
          { name: 'twilioCredId', label: 'Twilio Credential ID' }
        ],
        map: (v) => ({
          BIZ_NAME: v.bizName,
          AGENT_NAME: v.agentName,
          BIZ_EMAIL: v.email,
          OPENAI_MODEL: v.openaiModel,
          OFFER_SNIPPET: v.offerSnippet,
          CTA_URL: v.ctaUrl,
          FOLLOWUP_GAP_HOURS: v.followupGap || '24',
          AIRTABLE_BASE_ID: v.airtableBaseId || '',
          AIRTABLE_TABLE: v.airtableTable || 'Logs',
          AIRTABLE_CRED_ID: v.airtableCredId || '',
          SMTP_FROM: v.smtpFrom || 'no-reply@example.com',
          SMTP_CRED_ID: v.smtpCredId || 'SMTP_CREDENTIAL',
          TWILIO_FROM: v.twilioFrom || '',
          TWILIO_CRED_ID: v.twilioCredId || ''
        }),
        fileBase: 'salesCloser'
      },
      leadQualifier: {
        title: 'AI Lead Qualifier',
        desc: 'Score & route leads (A/B/C). Email both lead & owner with next steps.',
        promptId: 'prLeadQualifier',
        tplId: 'tplAgentLeadQualifier',
        fields: [
          { name: 'bizName', label: 'Business Name', required: true },
          { name: 'agentName', label: 'Agent Name', value: 'Ava' },
          { name: 'email', label: 'Owner/Team Email', required: true },
          { name: 'openaiModel', label: 'OpenAI Model', value: 'gpt-4o-mini' },
          { name: 'qualRules', label: 'Qualifier Rules (A/B/C tiers)', value: 'A: ready budget & timeline; B: missing one; C: mismatch' },
          { name: 'airtableBaseId', label: 'Airtable Base ID' },
          { name: 'airtableTable', label: 'Airtable Table', value: 'Leads' },
          { name: 'airtableCredId', label: 'Airtable Credential ID' },
          { name: 'smtpFrom', label: 'SMTP From (no-reply@...)' },
          { name: 'smtpCredId', label: 'SMTP Credential ID' }
        ],
        map: (v) => ({
          BIZ_NAME: v.bizName,
          AGENT_NAME: v.agentName,
          BIZ_EMAIL: v.email,
          OPENAI_MODEL: v.openaiModel,
          QUAL_RULES: v.qualRules,
          AIRTABLE_BASE_ID: v.airtableBaseId || '',
          AIRTABLE_TABLE: v.airtableTable || 'Logs',
          AIRTABLE_CRED_ID: v.airtableCredId || '',
          SMTP_FROM: v.smtpFrom || 'no-reply@example.com',
          SMTP_CRED_ID: v.smtpCredId || 'SMTP_CREDENTIAL'
        }),
        fileBase: 'leadQualifier'
      },
      dmResponder: {
        title: 'AI DM Responder',
        desc: 'Short replies for IG/TikTok that push to your CTA. Tags & logs.',
        promptId: 'prDMResponder',
        tplId: 'tplAgentDMResponder',
        fields: [
          { name: 'bizName', label: 'Business Name', required: true },
          { name: 'agentName', label: 'Agent Name', value: 'Ava' },
          { name: 'email', label: 'Owner/Team Email (for logs)', required: true },
          { name: 'openaiModel', label: 'OpenAI Model', value: 'gpt-4o-mini' },
          { name: 'platformWebhook', label: 'Platform Reply Webhook (Make/Zapier)', required: true },
          { name: 'bookUrl', label: 'Booking URL', required: true },
          { name: 'faqUrl', label: 'FAQ URL' },
          { name: 'airtableBaseId', label: 'Airtable Base ID' },
          { name: 'airtableTable', label: 'Airtable Table', value: 'DMs' },
          { name: 'airtableCredId', label: 'Airtable Credential ID' }
        ],
        map: (v) => ({
          BIZ_NAME: v.bizName,
          AGENT_NAME: v.agentName,
          BIZ_EMAIL: v.email,
          OPENAI_MODEL: v.openaiModel,
          PLATFORM_REPLY_WEBHOOK: v.platformWebhook,
          BOOK_URL: v.bookUrl,
          FAQ_URL: v.faqUrl || '',
          PRIMARY_CTA: 'book',
          AIRTABLE_BASE_ID: v.airtableBaseId || '',
          AIRTABLE_TABLE: v.airtableTable || 'Logs',
          AIRTABLE_CRED_ID: v.airtableCredId || ''
        }),
        fileBase: 'dmResponder'
      }
    };

    function getScriptText(id) {
      const el = $(id);
      if (!el) throw new Error('Missing script: ' + id);
      return el.textContent || '';
    }

    function embedPromptInJSON(prompt) {
      // Use JSON.stringify to properly escape, then remove outer quotes
      const escaped = JSON.stringify(prompt);
      // Remove the leading and trailing quotes that JSON.stringify adds
      return escaped.slice(1, -1);
    }

    function renderAgentForm(agent) {
      const form = $('agentForm');
      if (!form) return;
      
      form.innerHTML = '';
      
      agent.fields.forEach(field => {
        const wrapper = document.createElement('div');
        wrapper.className = 'field';
        
        const label = document.createElement('label');
        label.textContent = field.label + (field.required ? ' *' : '');
        
        const input = document.createElement('input');
        input.name = field.name;
        input.value = field.value || '';
        input.placeholder = field.label;
        if (field.required) input.required = true;
        
        wrapper.appendChild(label);
        wrapper.appendChild(input);
        form.appendChild(wrapper);
      });
    }

    function getAgentValues() {
      const form = $('agentForm');
      if (!form) return {};
      return Object.fromEntries(new FormData(form).entries());
    }

    function buildAgent(agent) {
      const values = getAgentValues();
      
      // Check required fields
      const missing = agent.fields
        .filter(f => f.required && !values[f.name]?.trim())
        .map(f => f.label);
      
      if (missing.length) {
        throw new Error('Missing required fields: ' + missing.join(', '));
      }
      
      // Build mapped values
      const map = agent.map(values);
      
      // Get prompt template
      let prompt = getScriptText(agent.promptId);
      prompt = injectPlaceholders(prompt, map);
      
      // Get workflow template
      let workflow = getScriptText(agent.tplId);
      
      // Embed prompt into workflow (replace YOU_ARE_* token)
      const embeddedPrompt = embedPromptInJSON(prompt);
      workflow = workflow.replace(/YOU_ARE_[A-Z_]+/g, embeddedPrompt);
      
      // Replace other placeholders
      workflow = injectPlaceholders(workflow, map);
      
      // Parse and re-stringify to validate
      try {
        const parsed = JSON.parse(workflow);
        workflow = JSON.stringify(parsed, null, 2);
      } catch (e) {
        throw new Error('Invalid workflow JSON: ' + e.message);
      }
      
      return { prompt, workflow };
    }

    function setDownloadLink(linkId, filename, content, mimeType) {
      const link = $(linkId);
      if (!link) return;
      
      const blob = new Blob([content], { type: mimeType });
      const url = URL.createObjectURL(blob);
      link.href = url;
      link.download = filename;
      
      // Clean up old URL when clicked
      link.addEventListener('click', () => {
        setTimeout(() => URL.revokeObjectURL(url), 100);
      }, { once: true });
    }

    /* ============ ROUTING ============ */
    function navigate() {
      const hash = location.hash || '#/';
      const viewHome = $('view-home');
      const viewAgent = $('view-agent');
      
      if (!viewHome || !viewAgent) return;
      
      const match = hash.match(/^#\/agent\/([a-zA-Z0-9_-]+)$/);
      
      if (match) {
        const agentKey = match[1];
        const agent = AGENTS[agentKey];
        
        if (!agent) {
          location.hash = '#/';
          return;
        }
        
        // Show agent view
        viewHome.classList.add('hidden');
        viewAgent.classList.remove('hidden');
        
        // Populate agent details
        $('agentTitle').textContent = agent.title;
        $('agentDesc').textContent = agent.desc;
        
        // Render form
        renderAgentForm(agent);
        
        // Clear preview
        $('agentPromptPreview').textContent = '';
        $('agentMsg').classList.add('hidden');
        
        // Wire generate button
        $('agentGenerate').onclick = (e) => {
          e.preventDefault();
          
          try {
            const result = buildAgent(agent);
            
            // Show preview
            $('agentPromptPreview').textContent = result.prompt;
            
            // Setup downloads
            setDownloadLink(
              'agentPromptDownload',
              `${agent.fileBase}-prompt.txt`,
              result.prompt,
              'text/plain'
            );
            
            setDownloadLink(
              'agentJsonDownload',
              `${agent.fileBase}-workflow.json`,
              result.workflow,
              'application/json'
            );
            
            // Show success message
            const msg = $('agentMsg');
            msg.classList.remove('hidden');
            setTimeout(() => msg.classList.add('hidden'), 2000);
            
          } catch (err) {
            console.error(err);
            alert('Error: ' + err.message);
          }
        };
        
        // Prevent download clicks if not generated
        $('agentPromptDownload').onclick = (e) => {
          if (!$('agentPromptPreview').textContent) {
            e.preventDefault();
            alert('Please generate the agent first');
          }
        };
        
        $('agentJsonDownload').onclick = (e) => {
          if (!$('agentPromptPreview').textContent) {
            e.preventDefault();
            alert('Please generate the agent first');
          }
        };
        
      } else {
        // Show home view
        viewAgent.classList.add('hidden');
        viewHome.classList.remove('hidden');
      }
    }

    /* ============ INIT ============ */
    function init() {
      // Set year
      const yearEl = $('year');
      if (yearEl) yearEl.textContent = new Date().getFullYear();
      
      // Initialize components
      initChat();
      initAudioPlayer();
      navigate();
      
      // Wire preview button
      const previewBtn = $('previewBtn');
      if (previewBtn) {
        previewBtn.addEventListener('click', (e) => {
          e.preventDefault();
          generatePreview();
        });
      }
      
      // Wire TTS button
      const ttsBtn = $('ttsBtn');
      if (ttsBtn) {
        ttsBtn.addEventListener('click', (e) => {
          e.preventDefault();
          generateTTS();
        });
      }
      
      // Handle navigation
      window.addEventListener('hashchange', navigate);
    }

    // Start when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }

  })();
  </script>
</body>
</html>0
          }
        ]
      ]
    },
    "Check Availability Tool": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1",
    "timezone": "{{TIMEZONE}}"
  }
}
  </script>

  <script id="tplBookAppointment" type="application/json">
{
  "name": "bookAppointment",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "{{WEBHOOK_PATH_BOOK}}",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [240, 300],
      "id": "webhook-book",
      "name": "Webhook",
      "webhookId": "{{WEBHOOK_ID_BOOK}}"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{$json.body.systemPrompt || 'You are an appointment booking assistant. Create calendar events with the provided details.'}}",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2.2,
      "position": [560, 300],
      "id": "ai-agent-book",
      "name": "AI Agent"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "mode": "list",
          "value": "gpt-4o-mini"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [560, 500],
      "id": "openai-book",
      "name": "OpenAI Chat Model"
    },
    {
      "parameters": {
        "calendar": {
          "__rl": true,
          "value": "{{CALENDAR_ID}}",
          "mode": "list",
          "cachedResultName": "{{CALENDAR_ID}}"
        },
        "start": "={{ $json.body.startTime || $now.toISO() }}",
        "end": "={{ $json.body.endTime || $now.plus({ hours: 1 }).toISO() }}",
        "additionalFields": {
          "attendees": "={{ $json.body.attendeeEmail ? [$json.body.attendeeEmail] : [] }}",
          "description": "=Appointment Details:\nName: {{ $json.body.customerName || 'N/A' }}\nEmail: {{ $json.body.attendeeEmail || 'N/A' }}\nPhone: {{ $json.body.customerPhone || 'N/A' }}\nService: {{ $json.body.serviceType || 'Standard appointment' }}",
          "summary": "=Appointment: {{ $json.body.customerName || 'New booking' }} - {{ $json.body.serviceType || 'Service' }}"
        }
      },
      "type": "n8n-nodes-base.googleCalendarTool",
      "typeVersion": 1.3,
      "position": [760, 500],
      "id": "calendar-create",
      "name": "Create Calendar Event Tool"
    },
    {
      "parameters": {
        "fromEmail": "={{CONFIRMATION_EMAIL}}",
        "toEmail": "={{ $json.body.attendeeEmail || '' }}",
        "subject": "=Appointment Confirmed - {{BIZ_NAME}}",
        "text": "=Hi {{ $json.body.customerName || 'there' }},\n\nYour appointment has been confirmed!\n\nDate & Time: {{ $json.body.startTime }}\nService: {{ $json.body.serviceType || 'Standard appointment' }}\n\nWe look forward to seeing you!\n\nBest regards,\n{{BIZ_NAME}}",
        "options": {}
      },
      "type": "n8n-nodes-base.emailSend",
      "typeVersion": 2.1,
      "position": [960, 400],
      "id": "send-email",
      "name": "Send Confirmation Email"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={\n  \"success\": true,\n  \"message\": \"Appointment booked successfully\",\n  \"details\": {\n    \"customerName\": {{ $json.body.customerName ? JSON.stringify($json.body.customerName) : '\"\"' }},\n    \"startTime\": {{ $json.body.startTime ? JSON.stringify($json.body.startTime) : '\"\"' }},\n    \"serviceType\": {{ $json.body.serviceType ? JSON.stringify($json.body.serviceType) : '\"\"' }}\n  }\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [1160, 300],
      "id": "respond-book",
      "name": "Respond to Webhook"
    }
  ],
  "connections": {
    "Webhook": {
      "main": [
        [
          {
            "node": "AI Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent": {
      "main": [
        [
          {
            "node": "Send Confirmation Email",
            "type": "main",
            "index": 0
          },
          {
            "node": "Respond to Webhook",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent",
            "type": "ai_languageModel",
            "index":
