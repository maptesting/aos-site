<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AOS â€” AI Receptionist Prompt Pack (Free Builder)</title>

  <!-- SEO -->
  <meta name="description" content="Build your own AI Receptionist in 30 seconds â€” free. Generate prompts, workflows, and voice previews for any business.">
  <meta property="og:title" content="AOS â€” Free AI Receptionist Builder">
  <meta property="og:description" content="Generate a custom AI receptionist instantly â€” prompt, workflows, and voice demo included.">
  <meta property="og:image" content="https://yourdomain.com/og-preview.png">
  <meta property="og:type" content="website">
  <meta name="twitter:card" content="summary_large_image">

  <!-- Favicon -->
  <link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y=".9em" font-size="90">ðŸ¤–</text></svg>'>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = { theme: { extend: {
      colors:{ brand:{500:"#556dff",600:"#3d4fe6"}, ink:"#0b0f1a" },
      boxShadow:{ soft:"0 8px 30px rgba(0,0,0,.18)" }
    }}};
  </script>
  <style>
    body{background:#0b0f1a;color:#fff}
    .gradient{background:
      radial-gradient(1200px 600px at 20% -10%, rgba(85,109,255,.25), transparent 60%),
      radial-gradient(1000px 600px at 100% 0%, rgba(34,42,130,.35), transparent 60%);}
    .glass{backdrop-filter:blur(10px);background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.08)}
    .code{white-space:pre-wrap;font-family:ui-monospace,Menlo,Consolas,monospace}
    input,textarea,select{background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.1);border-radius:12px;padding:.9rem 1rem}
    input::placeholder,textarea::placeholder{color:rgba(255,255,255,.4)}
    input:focus,textarea:focus,select:focus{outline:none;box-shadow:0 0 0 2px rgba(85,109,255,.5)}
    .range {appearance:none;height:6px;border-radius:9999px;background:linear-gradient(to right,#556dff var(--pct,0%),rgba(255,255,255,.2) 0)}
    .range::-webkit-slider-thumb{appearance:none;width:14px;height:14px;border-radius:9999px;background:#fff;border:2px solid #556dff;box-shadow:0 0 0 3px rgba(85,109,255,.25)}
    .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,.1)}
    .muted{color:rgba(255,255,255,.65)}
  </style>
</head>
<body>
  <header class="gradient border-b border-white/10">
    <div class="max-w-6xl mx-auto px-4 py-6 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-9 h-9 rounded-xl bg-brand-500 grid place-items-center">ðŸ¤–</div>
        <div>
          <div class="font-semibold">AOS</div>
          <div class="text-white/60 text-xs">AI Optimization Solutions</div>
        </div>
      </div>
      <a href="#builder" class="px-4 py-2 rounded-xl bg-brand-500 hover:bg-brand-600">Build Free</a>
    </div>
  </header>

  <!-- Hero -->
  <section class="relative gradient overflow-hidden">
    <div class="mx-auto max-w-7xl px-4 pt-20 pb-16 md:pt-24 md:pb-24">
      <div class="grid md:grid-cols-2 gap-16 items-start">
        <!-- Left -->
        <div>
          <h1 class="text-4xl md:text-5xl font-extrabold leading-tight">
            AI Receptionist Prompt Pack â€” <span class="text-brand-500">Free Builder</span>
          </h1>
          <p class="mt-6 text-white/70 max-w-2xl leading-relaxed">
            Answer a few questions about your business. Get a production-ready System Prompt (preview) and
            download two <b>n8n</b> workflows â€” <em>checkAvailability</em> and <em>bookAppointment</em>.
          </p>
          <div class="mt-8">
            <a href="#builder" class="px-5 py-3 rounded-xl bg-brand-500 hover:bg-brand-600">Start Building</a>
          </div>
        </div>

        <!-- Live Demo Chat -->
        <div class="glass rounded-2xl p-6 md:p-8 shadow-soft mt-6 md:mt-0">
          <div class="text-sm text-white/60 mb-2">Talk to Ava â€” Receptionist at BrightSmile Dental Clinic</div>
          <div id="chatBox" class="h-64 overflow-y-auto bg-black/20 rounded-xl p-3 space-y-3 text-sm border border-white/10">
            <div class="flex gap-3">
              <div class="w-8 h-8 rounded-full bg-brand-500 grid place-items-center">ðŸ¤–</div>
              <div>Hi! This is Ava from BrightSmile Dental â€” how can I help you today?</div>
            </div>
          </div>
          <form id="chatForm" class="mt-3 flex gap-2" action="javascript:void(0)" autocomplete="off">
            <input id="chatInput" type="text" placeholder="Type your message..." class="flex-1 bg-white/5 border border-white/10 rounded-xl px-3 py-2 text-sm" required>
            <button id="chatSend" type="submit" class="bg-brand-500 hover:bg-brand-600 rounded-xl px-4 py-2 text-sm font-medium">Send</button>
          </form>
        </div>
      </div>
    </div>
  </section>

  <!-- Builder -->
  <section id="builder" class="py-24 md:py-32 scroll-mt-28">
    <div class="max-w-6xl mx-auto px-4">
      <h2 class="text-center text-3xl font-bold mb-10 text-white">Build your AI Receptionist here ðŸ‘‡</h2>
      <div class="glass rounded-2xl p-6 md:p-10">
        <div class="flex items-start justify-between gap-12 flex-col lg:flex-row">
          <!-- Form -->
          <div class="w-full lg:w-1/2">
            <h3 class="text-2xl font-semibold mb-4">Your Business</h3>
            <form id="aiForm" class="grid gap-4 mt-4">
              <input name="bizName" placeholder="Business Name" required>
              <input name="location" placeholder="Location / Service area" required>
              <input name="industry" placeholder="Industry (e.g., salon, rentals, clinic)" required>
              <input name="services" placeholder="Services (comma-separated)" required>
              <div class="grid md:grid-cols-2 gap-4">
                <input name="agentName" placeholder="Agent Name" value="Alex">
                <input name="language" placeholder="Language" value="English">
              </div>
              <div class="grid md:grid-cols-2 gap-4">
                <input name="hours" placeholder="Hours (e.g., Monâ€“Sat 9â€“6)">
                <input name="timezone" placeholder="Timezone (e.g., America/New_York)">
              </div>
              <div class="grid md:grid-cols-2 gap-4">
                <input name="calendarId" placeholder="Google Calendar ID (e.g., primary)">
                <input name="email" type="email" placeholder="Confirmation email sender (optional)">
              </div>
              <textarea name="policies" rows="2" placeholder="Policies / deposits / refunds (optional)"></textarea>

              <!-- Voice picker row -->
              <div class="grid md:grid-cols-2 gap-4 items-end">
                <div>
                  <label class="block text-sm text-white/70 mb-1" for="voiceSelect">Voice</label>
                  <select id="voiceSelect">
                    <option>Loading voicesâ€¦</option>
                  </select>
                </div>
                <div class="mt-3 md:mt-0 flex gap-3 flex-wrap">
                  <button type="button" id="previewBtn" class="px-4 py-3 rounded-xl bg-brand-500 hover:bg-brand-600 font-medium inline-flex items-center gap-2">
                    <span id="previewSpinner" class="hidden inline-block w-4 h-4 border-2 border-white/40 border-t-white rounded-full animate-spin"></span>
                    <span>Generate Preview</span>
                  </button>
                  <button type="button" id="ttsBtn" class="px-4 py-3 rounded-xl border border-white/10 hover:bg-white/5 font-medium">â–¶ Hear AI Greeting</button>
                </div>
              </div>
            </form>
          </div>

          <!-- Preview + Downloads + Audio -->
          <div class="w-full lg:w-1/2">
            <div class="glass rounded-2xl p-5 h-full">
              <h3 class="text-xl font-semibold">System Prompt â€” Preview</h3>
              <div class="text-xs text-white/60">Preview only (truncated)</div>
              <div id="promptOut" class="code text-sm bg-black/30 rounded-xl p-4 border border-white/10 min-h-[280px] mt-3"></div>

              <div class="mt-6">
                <h4 class="text-sm font-semibold text-white/80 mb-2">Downloads</h4>
                <div class="flex flex-wrap gap-2">
                  <button id="downloadPromptBtn" class="px-4 py-2 rounded-xl bg-brand-500/80 hover:bg-brand-600 font-medium disabled:opacity-50" disabled>Download Full Prompt (.txt)</button>
                  <button id="downloadAvailBtn" class="px-4 py-2 rounded-xl border border-white/10 hover:bg-white/5 disabled:opacity-50" disabled>Download: checkAvailability.json</button>
                  <button id="downloadBookBtn" class="px-4 py-2 rounded-xl border border-white/10 hover:bg-white/5 disabled:opacity-50" disabled>Download: bookAppointment.json</button>
                </div>
                <div id="successMsg" class="hidden mt-3 text-sm text-green-400">Downloaded âœ…</div>
              </div>

              <!-- Custom Audio Player -->
              <div class="mt-6">
                <audio id="audio" class="hidden"></audio>
                <div id="audioUI" class="hidden glass rounded-xl p-4">
                  <div class="flex items-center gap-3">
                    <button id="audioPlay" class="w-10 h-10 rounded-full bg-brand-500 hover:bg-brand-600 grid place-items-center text-black font-bold">â–¶</button>
                    <div class="flex-1">
                      <input id="audioSeek" type="range" min="0" max="100" value="0" class="w-full range">
                      <div class="flex justify-between text-xs text-white/60 mt-1">
                        <span id="audioTime">0:00</span>
                        <span id="audioDur">0:00</span>
                      </div>
                    </div>
                    <a id="audioDownload" download="ai-greeting.mp3" class="text-sm underline decoration-blue-400">Download</a>
                  </div>
                </div>
                <div id="notice" class="mt-2 text-xs text-white/60"></div>
                <div id="debug" class="mt-2 text-xs text-red-400"></div>
              </div>
            </div>
          </div>
        </div>

      </div>

      <!-- Tutorial video -->
      <div class="mt-10">
        <h3 class="text-xl font-semibold mb-3">How to use this builder (video)</h3>
        <div class="rounded-2xl overflow-hidden border border-white/10 shadow-soft aspect-video">
          <iframe
            class="w-full h-full"
            src="https://www.youtube.com/embed/Akwe5h3CQKo?si=Q-Uto-rIMjTar1vv"
            title="AOS â€” How to use the AI Receptionist Builder"
            frameborder="0"
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
            referrerpolicy="strict-origin-when-cross-origin"
            allowfullscreen></iframe>
        </div>
      </div>

      <p class="text-center text-sm text-white/50 mt-8">
        After import, attach your Google Calendar OAuth2 and OpenAI credentials in n8n.
      </p>
    </div>
  </section>

  <!-- =========================
       NEW: More Plug-and-Play Agents
       ========================= -->
  <section id="agents" class="py-20 border-t border-white/10">
    <div class="max-w-6xl mx-auto px-4">
      <h2 class="text-3xl font-bold mb-6">More Plug-and-Play Agents</h2>
      <p class="muted mb-6">These are separate from the receptionist. Fill the global settings below once, then click <b>Generate</b> on any card to get a customized prompt + n8n workflow JSON.</p>

      <!-- Global Agent Settings -->
      <div class="glass rounded-2xl p-6 md:p-8 mb-8">
        <h3 class="text-xl font-semibold mb-3">Global Agent Settings</h3>
        <div class="grid md:grid-cols-3 gap-3">
          <!-- Uses receptionist form values too (bizName, agentName, timezone, calendarId, email, etc.) -->
          <input id="ga_smtpFrom" class="w-full" placeholder="SMTP From Email (no-reply@...)">
          <input id="ga_smtpCredId" class="w-full" placeholder="n8n SMTP Credential ID">
          <input id="ga_openaiModel" class="w-full" placeholder="OpenAI Model (e.g., gpt-4o-mini)">
          <input id="ga_airtableBaseId" class="w-full" placeholder="Airtable Base ID">
          <input id="ga_airtableTable" class="w-full" placeholder="Airtable Table (e.g., Logs)">
          <input id="ga_airtableCredId" class="w-full" placeholder="Airtable Credential ID">
          <input id="ga_ctaUrl" class="w-full" placeholder="CTA URL / Checkout / Booking">
          <input id="ga_offerSnippet" class="w-full" placeholder="Offer snippet">
          <input id="ga_followupGap" class="w-full" placeholder="Followup gap hours (e.g., 24)">
          <input id="ga_platformWebhook" class="w-full" placeholder="DM Platform Reply Webhook (Make/Zapier)">
          <input id="ga_bookUrl" class="w-full" placeholder="Booking URL">
          <input id="ga_faqUrl" class="w-full" placeholder="FAQ URL">
          <input id="ga_paymentLink" class="w-full" placeholder="Payment Link (Stripe/PayPal)">
          <input id="ga_taxRules" class="w-full" placeholder="Tax Rules (optional)">
          <input id="ga_qualRules" class="w-full" placeholder="Qualifier Rules (A/B/C tiers)">
          <input id="ga_twilioFrom" class="w-full" placeholder="Twilio From +1...">
          <input id="ga_twilioCredId" class="w-full" placeholder="n8n Twilio Credential ID">
        </div>
        <p class="text-xs text-white/60 mt-3">Tip: Weâ€™ll also use your receptionist form values (business name, agent name, timezone, calendar ID, email).</p>
      </div>

      <!-- Cards -->
      <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4">
        <!-- Invoice -->
        <div class="glass rounded-2xl p-5">
          <h3 class="text-lg font-semibold">ðŸ§¾ AI Invoice / Follow-ups</h3>
          <p class="text-sm text-white/70">Generate invoices + polite reminders and email them. Logs to Airtable.</p>
          <div class="flex gap-2 mt-3 flex-wrap">
            <a class="btn-ghost px-3 py-2 rounded-xl" data-agent="invoice" data-action="prompt">Download Full Prompt</a>
            <a class="btn-ghost px-3 py-2 rounded-xl" data-agent="invoice" data-action="json">Download n8n JSON</a>
            <button class="px-3 py-2 rounded-xl bg-brand-500 hover:bg-brand-600" data-agent="invoice" data-action="build">Generate</button>
          </div>
        </div>

        <!-- Sales Closer -->
        <div class="glass rounded-2xl p-5">
          <h3 class="text-lg font-semibold">ðŸ“ˆ AI Sales Closer</h3>
          <p class="text-sm text-white/70">Objection-aware nudges via SMS/Email. Auto-logs follow-ups.</p>
          <div class="flex gap-2 mt-3 flex-wrap">
            <a class="btn-ghost px-3 py-2 rounded-xl" data-agent="salesCloser" data-action="prompt">Download Full Prompt</a>
            <a class="btn-ghost px-3 py-2 rounded-xl" data-agent="salesCloser" data-action="json">Download n8n JSON</a>
            <button class="px-3 py-2 rounded-xl bg-brand-500 hover:bg-brand-600" data-agent="salesCloser" data-action="build">Generate</button>
          </div>
        </div>

        <!-- Lead Qualifier -->
        <div class="glass rounded-2xl p-5">
          <h3 class="text-lg font-semibold">ðŸ“ž AI Lead Qualifier</h3>
          <p class="text-sm text-white/70">Score & route leads (A/B/C). Email both lead & owner with next steps.</p>
          <div class="flex gap-2 mt-3 flex-wrap">
            <a class="btn-ghost px-3 py-2 rounded-xl" data-agent="leadQualifier" data-action="prompt">Download Full Prompt</a>
            <a class="btn-ghost px-3 py-2 rounded-xl" data-agent="leadQualifier" data-action="json">Download n8n JSON</a>
            <button class="px-3 py-2 rounded-xl bg-brand-500 hover:bg-brand-600" data-agent="leadQualifier" data-action="build">Generate</button>
          </div>
        </div>

        <!-- DM Responder -->
        <div class="glass rounded-2xl p-5">
          <h3 class="text-lg font-semibold">ðŸ’¬ AI DM Responder</h3>
          <p class="text-sm text-white/70">Short replies for IG/TikTok that push to your CTA. Tags & logs.</p>
          <div class="flex gap-2 mt-3 flex-wrap">
            <a class="btn-ghost px-3 py-2 rounded-xl" data-agent="dmResponder" data-action="prompt">Download Full Prompt</a>
            <a class="btn-ghost px-3 py-2 rounded-xl" data-agent="dmResponder" data-action="json">Download n8n JSON</a>
            <button class="px-3 py-2 rounded-xl bg-brand-500 hover:bg-brand-600" data-agent="dmResponder" data-action="build">Generate</button>
          </div>
        </div>
      </div>

      <div id="agentsMsg" class="text-xs text-green-400 mt-4 hidden">Generated âœ“</div>
    </div>
  </section>

  <footer class="py-10 text-center text-white/40 text-sm">
    Â© <span id="year"></span> AOS â€” AI Optimization Solutions
  </footer>
  <script>document.getElementById('year').textContent = new Date().getFullYear();</script>

  <!-- ====== EMBEDDED TEMPLATES (RECEPTIONIST) ====== -->
  <script id="tplCheckAvailability" type="application/json">
{/* (unchanged â€” your existing JSON exactly as provided) */}
  </script>

  <script id="tplBookAppointment" type="application/json">
{/* (unchanged â€” your existing JSON exactly as provided) */}
  </script>
  <!-- ====== /EMBEDDED TEMPLATES ====== -->

  <!-- ====== NEW: AGENT PROMPTS (LONG) ====== -->
  <script id="prInvoice" type="text/plain">
You are {{AGENT_NAME}}, an invoice/follow-up assistant for {{BIZ_NAME}}.
Task: when provided a customer + line items, generate a clear, friendly invoice email with due date, payment link, and gentle follow-ups if overdue.

Must collect/accept:
- client name, email
- line items as [{desc, qty, unitPrice}] and compute totals
- taxes/fees per {{TAX_RULES_SNIPPET}} if provided
- terms, due date, payment link {{PAYMENT_LINK}}
- business contact {{BIZ_EMAIL}}

Tone: professional, 2â€“4 short sentences, no fluff.

OUTPUT JSON ONLY (no prose):
{ "intent":"invoice" | "reminder",
  "toEmail":"", "subject":"", "textBody":"",
  "total": number, "dueISO":"", "paymentLink":"{{PAYMENT_LINK}}"
}
If input suggests a reminder (overdue), set intent to "reminder" and adjust tone slightly firmer but polite.
  </script>

  <script id="prSalesCloser" type="text/plain">
You are {{AGENT_NAME}}, a sales closer for {{BIZ_NAME}}.
Goal: convert warm leads to a booked call or paid order.

Context inputs: lead name, last interaction, offer {{OFFER_SNIPPET}}, CTA {{CTA_URL}}.
Strategy:
- If no reply: send Nudge A, then Nudge B after {{FOLLOWUP_GAP_HOURS}} hours.
- If objection (price/timing/fit), answer briefly with one strong benefit and exactly one CTA link.
- If ready, ask for a call time (2 slots) or link directly to checkout.

OUTPUT JSON ONLY:
{ "to":"", "channel":"sms|email", "subject":"", "textBody":"", "nextFollowupHours": {{FOLLOWUP_GAP_HOURS}}, "stage":"A|B|Close" }
Keep copy short and human. No emojis unless the lead uses them.
  </script>

  <script id="prLeadQualifier" type="text/plain">
You are {{AGENT_NAME}}, a lead qualifier for {{BIZ_NAME}}.
Qualify leads and route them according to {{QUAL_RULES}}.

Collect or use:
name, email, phone, company, budget, timeline, service need, location.

OUTPUT JSON ONLY:
{ "score": 0-100, "tier":"A|B|C", "reason":"", "recommendedNext":"book_call|nurture|reject",
  "emailToLead": {"subject":"","textBody":""},
  "emailToOwner": {"subject":"","textBody":""}
}
Terse, friendly, zero fluff. Reasons should be one sentence.
  </script>

  <script id="prDMResponder" type="text/plain">
You are {{AGENT_NAME}}, a DM responder for {{BIZ_NAME}}.
Reply to IG/TikTok DMs with short, human messages that move users to {{PRIMARY_CTA}} (link: {{BOOK_URL}}).
If complex product questions arise, answer briefly and point to {{FAQ_URL}}.

OUTPUT JSON ONLY:
{"reply":"", "suggestedTag":"lead|customer|spam"}

One or two lines max. No emojis unless user uses them first.
  </script>
  <!-- ====== /AGENT PROMPTS ====== -->

  <!-- ====== NEW: AGENT TEMPLATES (n8n WORKFLOWS) ====== -->
  <script id="tplAgentInvoice" type="application/json">
{
  "name": "AI Invoice & Follow-ups",
  "nodes": [
    { "parameters": { "path": "invoice", "options": { "responseData": "={{$json}}" } }, "id": "1", "name": "Webhook (Create/Reminder)", "type": "n8n-nodes-base.webhook", "typeVersion": 1, "position": [240, 300] },
    { "parameters": { "functionCode": "const b=$json; return [{payload:b}];" }, "id": "2", "name": "Normalize", "type": "n8n-nodes-base.function", "typeVersion": 2, "position": [480, 300] },
    { "parameters": { "authentication": "none", "url": "https://api.openai.com/v1/chat/completions", "jsonParameters": true, "responseFormat": "json", "sendBody": true, "headerParametersJson": "{ \n  \"Authorization\": \"Bearer {{OPENAI_API_KEY}}\",\n  \"Content-Type\":\"application/json\"\n}", "bodyParametersJson": "={\n  \"model\":\"{{OPENAI_MODEL}}\",\n  \"temperature\":0.3,\n  \"messages\":[\n    {\"role\":\"system\",\"content\":\"YOU_ARE_INVOICE_ASSISTANT\"},\n    {\"role\":\"user\",\"content\": JSON.stringify($json.payload) }\n  ]\n}" }, "id": "3", "name": "OpenAI - Draft Invoice/Reminder", "type": "n8n-nodes-base.httpRequest", "typeVersion": 4, "position": [720, 300] },
    { "parameters": { "functionCode": "const c=$json.choices?.[0]?.message?.content?.trim()||\"\"; let p; try{p=JSON.parse(c);}catch(e){p={intent:\"invoice\",toEmail:\"\",subject:\"Invoice\",textBody:c,total:0};} return [p];" }, "id": "4", "name": "Parse JSON", "type": "n8n-nodes-base.function", "typeVersion": 2, "position": [960, 300] },
    { "parameters": { "fromEmail": "{{SMTP_FROM}}", "toEmail": "={{$json.toEmail}}", "subject": "={{$json.subject}}", "text": "={{$json.textBody}}" }, "id": "5", "name": "Send Email", "type": "n8n-nodes-base.emailSend", "typeVersion": 2, "position": [1180, 200], "credentials": { "smtp": { "id": "{{SMTP_CRED_ID}}", "name": "SMTP" } } },
    { "parameters": { "operation": "create", "base": "{{AIRTABLE_BASE_ID}}", "table": "{{AIRTABLE_TABLE}}", "fieldsUi": { "field": [ { "fieldId": "Client", "fieldValue": "={{$json.toEmail}}" }, { "fieldId": "Subject", "fieldValue": "={{$json.subject}}" }, { "fieldId": "Total", "fieldValue": "={{$json.total}}"}, { "fieldId": "DueISO", "fieldValue": "={{$json.dueISO}}"}, { "fieldId": "PaymentLink", "fieldValue": "={{$json.paymentLink}}"} ] } }, "id": "6", "name": "Log to Airtable", "type": "n8n-nodes-base.airtable", "typeVersion": 2, "position": [1180, 400], "credentials": { "airtableApi": { "id": "{{AIRTABLE_CRED_ID}}", "name": "Airtable API" } } },
    { "parameters": { "responseBody": "={{$json}}", "responseCode": 200 }, "id": "7", "name": "Return", "type": "n8n-nodes-base.respondToWebhook", "typeVersion": 1, "position": [1400, 300] }
  ],
  "connections": {
    "Webhook (Create/Reminder)": { "main": [ [ { "node": "Normalize", "type": "main", "index": 0 } ] ] },
    "Normalize": { "main": [ [ { "node": "OpenAI - Draft Invoice/Reminder", "type": "main", "index": 0 } ] ] },
    "OpenAI - Draft Invoice/Reminder": { "main": [ [ { "node": "Parse JSON", "type": "main", "index": 0 } ] ] },
    "Parse JSON": { "main": [ [ { "node": "Send Email", "type": "main", "index": 0 } ], [ { "node": "Log to Airtable", "type": "main", "index": 0 } ], [ { "node": "Return", "type": "main", "index": 0 } ] ] },
    "Send Email": { "main": [ [ { "node": "Return", "type": "main", "index": 0 } ] ] },
    "Log to Airtable": { "main": [ [ { "node": "Return", "type": "main", "index": 0 } ] ] }
  },
  "active": false
}
  </script>

  <script id="tplAgentSalesCloser" type="application/json">
{
  "name": "AI Sales Closer",
  "nodes": [
    { "parameters": { "path": "closer", "options": { "responseData": "={{$json}}" } }, "id": "1", "name": "Webhook (New Lead/Reply)", "type": "n8n-nodes-base.webhook", "typeVersion": 1, "position": [240, 300] },
    { "parameters": { "functionCode": "return [{$json}];" }, "id": "2", "name": "Pass", "type": "n8n-nodes-base.function", "typeVersion": 2, "position": [480, 300] },
    { "parameters": { "url": "https://api.openai.com/v1/chat/completions", "jsonParameters": true, "sendBody": true, "responseFormat": "json", "headerParametersJson": "{ \"Authorization\":\"Bearer {{OPENAI_API_KEY}}\",\"Content-Type\":\"application/json\"}", "bodyParametersJson": "={\"model\":\"{{OPENAI_MODEL}}\",\"temperature\":0.4,\"messages\":[{\"role\":\"system\",\"content\":\"YOU_ARE_SALES_CLOSER\"},{\"role\":\"user\",\"content\": JSON.stringify($json)}]}" }, "id": "3", "name": "OpenAI - Draft Reply", "type": "n8n-nodes-base.httpRequest", "typeVersion": 4, "position": [720, 300] },
    { "parameters": { "functionCode": "const s=$json.choices?.[0]?.message?.content?.trim()||\"\"; let p; try{p=JSON.parse(s);}catch(e){p={to:\"\",channel:\"sms\",textBody:s,subject:\"\"}} return [p];" }, "id": "4", "name": "Parse JSON", "type": "n8n-nodes-base.function", "typeVersion": 2, "position": [960, 300] },
    { "parameters": { "conditions": { "string": [ { "value1": "={{$json.channel}}", "operation": "equal", "value2": "sms" } ] } }, "id": "5", "name": "IF SMS?", "type": "n8n-nodes-base.if", "typeVersion": 1, "position": [1180, 260] },
    { "parameters": { "from": "{{TWILIO_FROM}}", "to": "={{$json.to}}", "message": "={{$json.textBody}}" }, "id": "6", "name": "Twilio - Send SMS", "type": "n8n-nodes-base.twilio", "typeVersion": 1, "position": [1400, 140], "credentials": { "twilioApi": { "id": "{{TWILIO_CRED_ID}}", "name": "Twilio" } } },
    { "parameters": { "fromEmail": "{{SMTP_FROM}}", "toEmail": "={{$json.to}}", "subject": "={{$json.subject}}", "text": "={{$json.textBody}}" }, "id": "7", "name": "Email - Send", "type": "n8n-nodes-base.emailSend", "typeVersion": 2, "position": [1400, 380], "credentials": { "smtp": { "id": "{{SMTP_CRED_ID}}", "name": "SMTP" } } },
    { "parameters": { "operation": "create", "base": "{{AIRTABLE_BASE_ID}}", "table": "{{AIRTABLE_TABLE}}", "fieldsUi": { "field": [ { "fieldId": "To", "fieldValue": "={{$json.to}}" }, { "fieldId": "Channel", "fieldValue": "={{$json.channel}}" }, { "fieldId": "Stage", "fieldValue": "={{$json.stage}}" }, { "fieldId": "NextFollowupHours", "fieldValue": "={{$json.nextFollowupHours}}" } ] } }, "id": "8", "name": "Log to Airtable", "type": "n8n-nodes-base.airtable", "typeVersion": 2, "position": [1620, 260], "credentials": { "airtableApi": { "id": "{{AIRTABLE_CRED_ID}}", "name": "Airtable API" } } },
    { "parameters": { "responseBody": "={{$json}}", "responseCode": 200 }, "id": "9", "name": "Return", "type": "n8n-nodes-base.respondToWebhook", "typeVersion": 1, "position": [1840, 260] }
  ],
  "connections": {
    "Webhook (New Lead/Reply)": { "main": [ [ { "node": "Pass", "type": "main", "index": 0 } ] ] },
    "Pass": { "main": [ [ { "node": "OpenAI - Draft Reply", "type": "main", "index": 0 } ] ] },
    "OpenAI - Draft Reply": { "main": [ [ { "node": "Parse JSON", "type": "main", "index": 0 } ] ] },
    "Parse JSON": {
      "main": [
        [ { "node": "IF SMS?", "type": "main", "index": 0 } ],
        [ { "node": "Email - Send", "type": "main", "index": 0 } ],
        [ { "node": "Log to Airtable", "type": "main", "index": 0 } ],
        [ { "node": "Return", "type": "main", "index": 0 } ]
      ]
    },
    "IF SMS?": {
      "main": [
        [ { "node": "Twilio - Send SMS", "type": "main", "index": 0 } ],
        [ { "node": "Email - Send", "type": "main", "index": 0 } ]
      ]
    },
    "Twilio - Send SMS": { "main": [ [ { "node": "Log to Airtable", "type": "main", "index": 0 } ] ] },
    "Email - Send": { "main": [ [ { "node": "Log to Airtable", "type": "main", "index": 0 } ] ] },
    "Log to Airtable": { "main": [ [ { "node": "Return", "type": "main", "index": 0 } ] ] }
  },
  "active": false
}
  </script>

  <script id="tplAgentLeadQualifier" type="application/json">
{
  "name": "AI Lead Qualifier",
  "nodes": [
    { "parameters": { "path": "lead", "options": { "responseData": "={{$json}}" } }, "id": "1", "name": "Webhook (Lead In)", "type": "n8n-nodes-base.webhook", "typeVersion": 1, "position": [240, 300] },
    { "parameters": { "functionCode": "return [{$json}];" }, "id": "2", "name": "Pass", "type": "n8n-nodes-base.function", "typeVersion": 2, "position": [480, 300] },
    { "parameters": { "url": "https://api.openai.com/v1/chat/completions", "jsonParameters": true, "sendBody": true, "responseFormat": "json", "headerParametersJson": "{ \"Authorization\":\"Bearer {{OPENAI_API_KEY}}\",\"Content-Type\":\"application/json\"}", "bodyParametersJson": "={\"model\":\"{{OPENAI_MODEL}}\",\"temperature\":0.2,\"messages\":[{\"role\":\"system\",\"content\":\"YOU_ARE_LEAD_QUALIFIER\"},{\"role\":\"user\",\"content\": JSON.stringify($json)}]}" }, "id": "3", "name": "OpenAI - Qualify", "type": "n8n-nodes-base.httpRequest", "typeVersion": 4, "position": [720, 300] },
    { "parameters": { "functionCode": "const t=$json.choices?.[0]?.message?.content?.trim()||\"\"; let p; try{p=JSON.parse(t);}catch(e){p={score:50,tier:\"B\",reason:t,recommendedNext:\"nurture\"}} return [p];" }, "id": "4", "name": "Parse JSON", "type": "n8n-nodes-base.function", "typeVersion": 2, "position": [960, 300] },
    { "parameters": { "conditions": { "string": [ { "value1": "={{$json.recommendedNext}}", "operation": "equal", "value2": "book_call" } ] } }, "id": "5", "name": "IF Book Call", "type": "n8n-nodes-base.if", "typeVersion": 1, "position": [1180, 240] },
    { "parameters": { "fromEmail": "{{SMTP_FROM}}", "toEmail": "={{$json.emailToLead?.to || $json.lead?.email || \"\"}}", "subject": "={{$json.emailToLead.subject}}", "text": "={{$json.emailToLead.textBody}}" }, "id": "6", "name": "Email Lead", "type": "n8n-nodes-base.emailSend", "typeVersion": 2, "position": [1400, 140], "credentials": { "smtp": { "id": "{{SMTP_CRED_ID}}", "name": "SMTP" } } },
    { "parameters": { "fromEmail": "{{SMTP_FROM}}", "toEmail": "{{BIZ_EMAIL}}", "subject": "={{$json.emailToOwner.subject}}", "text": "={{$json.emailToOwner.textBody}}" }, "id": "7", "name": "Email Owner", "type": "n8n-nodes-base.emailSend", "typeVersion": 2, "position": [1400, 300], "credentials": { "smtp": { "id": "{{SMTP_CRED_ID}}", "name": "SMTP" } } },
    { "parameters": { "operation": "create", "base": "{{AIRTABLE_BASE_ID}}", "table": "{{AIRTABLE_TABLE}}", "fieldsUi": { "field": [ { "fieldId": "Score", "fieldValue": "={{$json.score}}" }, { "fieldId": "Tier", "fieldValue": "={{$json.tier}}" }, { "fieldId": "Reason", "fieldValue": "={{$json.reason}}" }, { "fieldId": "Next", "fieldValue": "={{$json.recommendedNext}}" } ] } }, "id": "8", "name": "Log to Airtable", "type": "n8n-nodes-base.airtable", "typeVersion": 2, "position": [1620, 240], "credentials": { "airtableApi": { "id": "{{AIRTABLE_CRED_ID}}", "name": "Airtable API" } } },
    { "parameters": { "responseBody": "={{$json}}", "responseCode": 200 }, "id": "9", "name": "Return", "type": "n8n-nodes-base.respondToWebhook", "typeVersion": 1, "position": [1840, 240] }
  ],
  "connections": {
    "Webhook (Lead In)": { "main": [ [ { "node": "Pass", "type": "main", "index": 0 } ] ] },
    "Pass": { "main": [ [ { "node": "OpenAI - Qualify", "type": "main", "index": 0 } ] ] },
    "OpenAI - Qualify": { "main": [ [ { "node": "Parse JSON", "type": "main", "index": 0 } ] ] },
    "Parse JSON": { "main": [ [ { "node": "IF Book Call", "type": "main", "index": 0 } ], [ { "node": "Email Owner", "type": "main", "index": 0 } ], [ { "node": "Log to Airtable", "type": "main", "index": 0 } ], [ { "node": "Return", "type": "main", "index": 0 } ] ] },
    "IF Book Call": { "main": [ [ { "node": "Email Lead", "type": "main", "index": 0 } ] ] },
    "Email Lead": { "main": [ [ { "node": "Log to Airtable", "type": "main", "index": 0 } ] ] },
    "Email Owner": { "main": [ [ { "node": "Log to Airtable", "type": "main", "index": 0 } ] ] },
    "Log to Airtable": { "main": [ [ { "node": "Return", "type": "main", "index": 0 } ] ] }
  },
  "active": false
}
  </script>

  <script id="tplAgentDMResponder" type="application/json">
{
  "name": "AI DM Responder",
  "nodes": [
    { "parameters": { "path": "dm-responder", "options": { "responseData": "={{$json}}" } }, "id":"1","name":"Webhook (DM)","type":"n8n-nodes-base.webhook","typeVersion":1,"position":[240,300]},
    { "parameters": { "functionCode": "return [{$json}];" }, "id":"2","name":"Pass","type":"n8n-nodes-base.function","typeVersion":2,"position":[480,300]},
    { "parameters": { "url": "https://api.openai.com/v1/chat/completions","jsonParameters": true,"sendBody": true,"responseFormat":"json","headerParametersJson":"{\"Authorization\":\"Bearer {{OPENAI_API_KEY}}\",\"Content-Type\":\"application/json\"}","bodyParametersJson":"={\"model\":\"{{OPENAI_MODEL}}\",\"temperature\":0.5,\"messages\":[{\"role\":\"system\",\"content\":\"YOU_ARE_DM_RESPONDER\"},{\"role\":\"user\",\"content\": JSON.stringify($json)}]}" }, "id":"3","name":"OpenAI - DM Reply","type":"n8n-nodes-base.httpRequest","typeVersion":4,"position":[720,300]},
    { "parameters": { "functionCode": "const s=$json.choices?.[0]?.message?.content?.trim()||\"\"; let p; try{p=JSON.parse(s);}catch(e){p={reply:s,suggestedTag:\"lead\"}} return [p];" }, "id":"4","name":"Parse JSON","type":"n8n-nodes-base.function","typeVersion":2,"position":[960,300]},
    { "parameters": { "url": "{{PLATFORM_REPLY_WEBHOOK}}", "jsonParameters": true, "options": {}, "sendBody": true, "bodyParametersJson": "={\"conversationId\": $json.conversationId || \"\", \"reply\": $json.reply }" }, "id":"5","name":"HTTP - Send Reply to Platform","type":"n8n-nodes-base.httpRequest","typeVersion":4,"position":[1180,220]},
    { "parameters": { "operation": "create", "base": "{{AIRTABLE_BASE_ID}}", "table": "{{AIRTABLE_TABLE}}", "fieldsUi": { "field": [ { "fieldId": "ConversationId", "fieldValue": "={{$json.conversationId}}"}, { "fieldId": "Reply", "fieldValue": "={{$json.reply}}"}, { "fieldId": "Tag", "fieldValue": "={{$json.suggestedTag}}"} ] } }, "id":"6","name":"Airtable - Log","type":"n8n-nodes-base.airtable","typeVersion":2,"position":[1180,380], "credentials":{"airtableApi":{"id":"{{AIRTABLE_CRED_ID}}","name":"Airtable API"}}},
    { "parameters": { "responseBody":"={{$json}}","responseCode":200 }, "id":"7","name":"Return","type":"n8n-nodes-base.respondToWebhook","typeVersion":1,"position":[1400,300]}
  ],
  "connections": {
    "Webhook (DM)": { "main": [ [ { "node": "Pass", "type": "main", "index": 0 } ] ] },
    "Pass": { "main": [ [ { "node": "OpenAI - DM Reply", "type": "main", "index": 0 } ] ] },
    "OpenAI - DM Reply": { "main": [ [ { "node": "Parse JSON", "type": "main", "index": 0 } ] ] },
    "Parse JSON": { "main": [ [ { "node": "HTTP - Send Reply to Platform", "type": "main", "index": 0 } ], [ { "node": "Airtable - Log", "type": "main", "index": 0 } ], [ { "node": "Return", "type": "main", "index": 0 } ] ] },
    "HTTP - Send Reply to Platform": { "main": [ [ { "node": "Return", "type": "main", "index": 0 } ] ] },
    "Airtable - Log": { "main": [ [ { "node": "Return", "type": "main", "index": 0 } ] ] }
  },
  "active": false
}
  </script>
  <!-- ====== /AGENT TEMPLATES ====== -->

  <!-- Binder: chat send, TTS player, personalized JSON downloads, prompt + NEW agent builder -->
  <script>
  (function(){
    const $ = (id)=>document.getElementById(id);

    /* ---------------- DEMO CHAT ---------------- */
    function addMsg(role, text){
      const wrap = $('chatBox'); if(!wrap) return;
      const row = document.createElement('div');
      row.className = 'flex gap-3';
      if(role==='user'){ row.className += ' justify-end'; }
      row.innerHTML = role==='user'
        ? `<div class="max-w-[75%] bg-brand-500/20 rounded-xl px-3 py-2">${escapeHtml(text)}</div>`
        : `<div class="w-8 h-8 rounded-full bg-brand-500 grid place-items-center">ðŸ¤–</div><div class="max-w-[75%] bg-white/5 rounded-xl px-3 py-2">${escapeHtml(text)}</div>`;
      wrap.appendChild(row);
      wrap.scrollTop = wrap.scrollHeight;
    }
    function escapeHtml(s){return (s||'').replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[m]))}
    function wireChat(){
      const form=$('chatForm'), input=$('chatInput');
      if(!form || !input) return;
      form.addEventListener('submit',(e)=>{
        e.preventDefault();
        const t=input.value.trim(); if(!t) return;
        addMsg('user', t);
        input.value='';
        setTimeout(()=>addMsg('bot', "Thanks! (Demo chat only) â€” the real receptionist runs in your n8n workflows."), 400);
      });
      $('chatSend')?.addEventListener('click',()=>form.requestSubmit());
    }

    /* -------------- FORM & PROMPT -------------- */
    function getValues(){
      const form = $('aiForm'); if(!form) return {};
      const v = Object.fromEntries(new FormData(form).entries());
      try{ v.timezone ||= Intl.DateTimeFormat().resolvedOptions().timeZone || ""; }catch{}
      v.agentName ||= 'Alex'; v.language ||= 'English';
      return v;
    }
    const truncate=(s,n=1200)=> s && s.length>n ? s.slice(0,n)+' â€¦' : (s||'');

    function buildPrompt(v={}){
      const tz=v.timezone||'America/New_York', biz=v.bizName||'the business', agent=v.agentName||'Alex';
      const industry=v.industry||'services', services=v.services||'General services', hours=v.hours||'Monâ€“Fri 9:00â€“17:00';
      const location=v.location||'Local area', policies=v.policies||'Standard policies apply.', emailFrom=v.email||'no-reply@example.com';
      const now=(()=>{try{return new Date().toLocaleString('en-US',{timeZone:tz,weekday:'long',year:'numeric',month:'long',day:'2-digit',hour:'2-digit',minute:'2-digit'})}catch{return new Date().toLocaleString()}})();
      const L=(x,l)=>`${l}: ${x||'N/A'}`;
      return [
`# ROLE
You are ${agent}, a friendly, efficient AI receptionist for **${biz}** (${industry}). Keep replies to 1â€“2 sentences, natural and clear.

# CURRENT TIME
- Current time: **${now}**
- Timezone: **${tz}**
Use ISO 8601 timestamps when interacting with tools.

# BUSINESS CONTEXT
${L(biz,'Business')}
${L(location,'Location / Service')}
${L(industry,'Industry')}
${L(services,'Services')}
${L(hours,'Hours')}
${L(policies,'Policies')}

# TASK
Answer questions and help book appointments quickly.

# BOOKING FLOW
1) Ask for the preferred date/time (within ${hours}).
2) Check the requested slot.
3) If unavailable, propose up to 3 close alternatives (same day or next business day).
4) Collect full name, email, phone.
5) Confirm slot and create the booking.
6) Summarize details and say a confirmation will be sent from **${emailFrom}**.

# STYLE & RULES
Warm, concise, confident; use contractions. Donâ€™t invent availability outside ${hours}. Confirm final date/time + contact details.`
      ].join('\n');
    }
    function wirePromptDownload(){
      const btn = $('downloadPromptBtn'); if(!btn) return;
      btn.disabled = false;
      btn.onclick = (e)=>{
        e.preventDefault();
        const txt = buildPrompt(getValues());
        const a = document.createElement('a');
        a.href = URL.createObjectURL(new Blob([txt], { type:'text/plain;charset=utf-8' }));
        a.download = `${(getValues().bizName || 'AI_Receptionist')}_prompt.txt`;
        a.click(); URL.revokeObjectURL(a.href);
        flashOk('Prompt downloaded âœ…');
      };
    }
    function flashOk(msg){
      const ok=$('successMsg'); if(!ok) return;
      ok.textContent = msg; ok.classList.remove('hidden');
      clearTimeout(ok._t); ok._t=setTimeout(()=>ok.classList.add('hidden'),2000);
    }

    /* -------------- JSON TEMPLATING (RECEPTIONIST) -------------- */
    function readTplObject(id){
      const node=$(id);
      if(!node){
        const n=$('notice'); if(n) n.textContent=`Template "${id}" is missing â€” make sure the <script id="${id}" type="application/json"> block is present above the main script.`;
        throw new Error('Missing template node: '+id);
      }
      const text=node.textContent??'';
      if(!text.trim()){
        const n=$('notice'); if(n) n.textContent=`Template "${id}" is empty.`;
        throw new Error('Empty template: '+id);
      }
      // allow blocking comments for brevity placeholder
      const cleaned = text.trim().startsWith('{/*') ? node.innerHTML.replace(/^[\s\S]*?<script[^>]+>|\s*<\/script>\s*$/g,'') : text;
      return JSON.parse(text.trim().startsWith('{/*') ? text.replace(/^\{\/*.*\*\/\}/,'{}') : text);
    }
    const slug=(s)=> (s||'').toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'').slice(0,48)||'biz';
    function setWorkflowTimezone(obj, tz){ obj.settings=obj.settings||{}; obj.settings.timezone = tz || obj.settings.timezone || 'America/New_York'; }
    function patchCalendarToolNode(obj, idOrPrimary){
      (obj.nodes||[]).forEach(n=>{
        if(n?.type==='n8n-nodes-base.googleCalendarTool' && n.parameters?.calendar && typeof n.parameters.calendar==='object'){
          n.parameters.calendar.value = idOrPrimary;
          n.parameters.calendar.cachedResultName = idOrPrimary;
        }
      });
    }
    function patchWebhookPath(obj, newPath){
      (obj.nodes||[]).forEach(n=>{
        if(n?.type==='n8n-nodes-base.webhook' && n.parameters){ n.parameters.path = newPath || n.parameters.path; }
      });
    }
    function renderWorkflow(tplId, v, kind){
      const obj=readTplObject(tplId);
      setWorkflowTimezone(obj, v.timezone);
      patchCalendarToolNode(obj, v.calendarId || 'primary');
      const base = 'aos-'+slug(v.bizName);
      patchWebhookPath(obj, kind==='book' ? `${base}-book` : `${base}-check`);
      return JSON.stringify(obj, null, 2);
    }
    function enableDownload(btnId, text, name){
      const btn=$(btnId); if(!btn) return;
      btn.disabled=false; btn.onclick=(e)=>{
        e.preventDefault();
        const a=document.createElement('a');
        a.href=URL.createObjectURL(new Blob([text],{type:'application/json'}));
        a.download=name; a.click(); URL.revokeObjectURL(a.href);
        flashOk(name+' downloaded âœ…');
      };
    }

    /* -------------- CUSTOM AUDIO PLAYER -------------- */
    function fmt(s){ s = Math.max(0, s|0); const m=(s/60)|0, sec=(s%60)|0; return m+':'+(sec<10?'0':'')+sec; }
    function wireAudioUI(){
      const a=$('audio'), box=$('audioUI'); if(!a || !box) return;
      const btn=$('audioPlay'), seek=$('audioSeek'), t=$('audioTime'), d=$('audioDur');
      function sync(){
        if(!isFinite(a.duration)) return;
        d.textContent = fmt(a.duration);
        t.textContent = fmt(a.currentTime);
        const pct = a.currentTime / Math.max(1, a.duration) * 100;
        seek.value = pct;
        seek.style.setProperty('--pct', pct+'%');
        btn.textContent = a.paused ? 'â–¶' : 'â¸';
      }
      btn.addEventListener('click',()=>{ a.paused ? a.play() : a.pause(); });
      a.addEventListener('play', sync);
      a.addEventListener('pause', sync);
      a.addEventListener('timeupdate', sync);
      a.addEventListener('loadedmetadata', ()=>{ box.classList.remove('hidden'); sync(); });
      seek.addEventListener('input', ()=>{
        const pct = parseFloat(seek.value||'0')/100;
        if(isFinite(a.duration)) a.currentTime = a.duration*pct;
        seek.style.setProperty('--pct', seek.value+'%');
      });
    }

    /* -------------- RECEPTIONIST ACTIONS -------------- */
    async function doPreview(){
      const spinner=$('previewSpinner'), btn=$('previewBtn'), out=$('promptOut');
      btn.disabled=true; spinner?.classList.remove('hidden');
      try{
        const v=getValues();
        out.textContent = (truncate(buildPrompt(v)));
        wirePromptDownload();
        const avail = renderWorkflow('tplCheckAvailability', v, 'check');
        const book  = renderWorkflow('tplBookAppointment',  v, 'book');
        enableDownload('downloadAvailBtn', avail, 'checkAvailability.json');
        enableDownload('downloadBookBtn',  book,  'bookAppointment.json');
        const n=$('notice'); if(n) n.textContent='Downloads ready. JSONs customized with your Calendar ID, Timezone, and unique webhook paths.';
      }catch(e){ console.error(e); alert('Error preparing downloads: '+e.message); }
      finally{ spinner?.classList.add('hidden'); btn.disabled=false; }
    }

    /* ---------- Voices + TTS ---------- */
    async function loadVoices() {
      const sel = $('voiceSelect'); if (!sel) return;
      try {
        const r = await fetch('/api/voices');
        const j = await r.json();
        sel.innerHTML = '';
        if (j.ok && Array.isArray(j.data.voices) && j.data.voices.length) {
          j.data.voices.forEach(v => {
            const opt = document.createElement('option');
            opt.value = v.id; opt.textContent = v.name;
            sel.appendChild(opt);
          });
          return;
        }
      } catch {}
      sel.innerHTML = '';
      [
        { id:'', name:'Default' },
        { id:'56bWURjYFHyYyVf490Dp', name:'Emma' },
        { id:'UgBBYS2sOqTuMpoF3BR0', name:'Mark' }
      ].forEach(v=>{
        const opt=document.createElement('option');
        opt.value=v.id; opt.textContent=v.name; sel.appendChild(opt);
      });
    }

    async function doTTS(){
      const ttsBtn = $('ttsBtn'); if (ttsBtn) ttsBtn.disabled = true;
      const v=getValues();
      const voice_id = ($('voiceSelect')?.value)||'';
      const text=`Hey, this is ${v.agentName||'Alex'} with ${v.bizName||'your business'}. How can I help you today?`;

      async function call(body){
        const res = await fetch('/api/tts', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
        let data=null; try{ data=await res.json(); }catch{}
        if(!res.ok || !data?.ok){
          const msg = data?.message || `HTTP ${res.status}`;
          const code= data?.code || 'UNKNOWN';
          throw new Error(`[${code}] ${msg}`);
        }
        return data.data.audioBase64;
      }

      try{
        let audioB64;
        try{
          const body = { text }; if (voice_id) body.voice_id = voice_id;
          audioB64 = await call(body);
        }catch(e){
          if(String(e.message).includes('[UPSTREAM]')){
            audioB64 = await call({ text });
          } else { throw e; }
        }
        const a=$('audio');
        a.src = audioB64; a.load();
        $('audioDownload').href = audioB64;
        await a.play().catch(()=>{});
      }catch(e){
        console.error(e); alert('TTS failed: '+ e.message);
      } finally {
        if (ttsBtn) ttsBtn.disabled = false;
      }
    }

    // Receptionist events
    document.addEventListener('click',(ev)=>{
      if(ev.target.closest('#previewBtn')){ ev.preventDefault(); doPreview(); }
      if(ev.target.closest('#ttsBtn')){ ev.preventDefault(); doTTS(); }
    });

    /* ============================
       NEW: AGENT BUILDER LOGIC
       ============================ */
    const AGENTS = {
      invoice: { promptId:'prInvoice', tplId:'tplAgentInvoice', filename:'invoice' },
      salesCloser: { promptId:'prSalesCloser', tplId:'tplAgentSalesCloser', filename:'salesCloser' },
      leadQualifier: { promptId:'prLeadQualifier', tplId:'tplAgentLeadQualifier', filename:'leadQualifier' },
      dmResponder: { promptId:'prDMResponder', tplId:'tplAgentDMResponder', filename:'dmResponder' }
    };

    function g(id){ return (document.getElementById(id)?.value||'').trim(); }
    function injectPlaceholders(str, map){
      return Object.entries(map).reduce((acc,[k,v])=> acc.replaceAll(`{{${k}}}`, String(v ?? '')), String(str));
    }

    function getGlobalAgentVals(){
      const r = getValues(); // pulls from your receptionist form
      return {
        // business / identity
        BIZ_NAME: r.bizName || 'Your Business',
        AGENT_NAME: r.agentName || 'Ava',
        TIMEZONE: r.timezone || 'America/New_York',
        BIZ_EMAIL: r.email || 'owner@example.com',

        // model / creds (model also overridable in GA section)
        OPENAI_MODEL: g('ga_openaiModel') || 'gpt-4o-mini',
        OPENAI_API_KEY: 'USE_N8N_CREDENTIALS', // placeholder; set in n8n creds

        // smtp
        SMTP_FROM: g('ga_smtpFrom') || 'no-reply@example.com',
        SMTP_CRED_ID: g('ga_smtpCredId') || 'SMTP_CREDENTIAL_ID',

        // airtable
        AIRTABLE_BASE_ID: g('ga_airtableBaseId') || 'appXXXXXXXXXXXXXX',
        AIRTABLE_TABLE: g('ga_airtableTable') || 'Logs',
        AIRTABLE_CRED_ID: g('ga_airtableCredId') || 'AIRTABLE_CREDENTIAL_ID',

        // sales / dm
        CTA_URL: g('ga_ctaUrl') || 'https://yourlink.com',
        OFFER_SNIPPET: g('ga_offerSnippet') || 'Quick value summary.',
        FOLLOWUP_GAP_HOURS: g('ga_followupGap') || '24',
        PLATFORM_REPLY_WEBHOOK: g('ga_platformWebhook') || 'https://example.com/reply',
        BOOK_URL: g('ga_bookUrl') || 'https://cal.com/you',
        FAQ_URL: g('ga_faqUrl') || 'https://yourdomain.com/faq',
        PRIMARY_CTA: 'book',

        // invoice
        PAYMENT_LINK: g('ga_paymentLink') || 'https://pay.yourdomain.com',
        TAX_RULES_SNIPPET: g('ga_taxRules') || '',

        // qualifier
        QUAL_RULES: g('ga_qualRules') || 'A: ready budget & timeline; B: missing one; C: mismatch',

        // twilio
        TWILIO_FROM: g('ga_twilioFrom') || '+15555555555',
        TWILIO_CRED_ID: g('ga_twilioCredId') || 'TWILIO_CREDENTIAL_ID'
      };
    }

    function getScriptText(id){
      const el = document.getElementById(id);
      if(!el) throw new Error('Missing node: '+id);
      return el.textContent || '';
    }

    function setDownload(anchorOrBtn, filename, data, mime='application/octet-stream'){
      const a = anchorOrBtn.tagName === 'A' ? anchorOrBtn : document.createElement('a');
      const blob = new Blob([data], { type: mime });
      const url = URL.createObjectURL(blob);
      a.href = url; a.download = filename;
      if(anchorOrBtn.tagName !== 'A'){
        a.click(); URL.revokeObjectURL(url);
      } else {
        // keep href for user click
      }
    }

    function buildAgent(agentKey){
      const def = AGENTS[agentKey]; if(!def) throw new Error('Unknown agent: '+agentKey);
      const vals = getGlobalAgentVals();

      // Prompt
      let prompt = getScriptText(def.promptId);
      prompt = injectPlaceholders(prompt, vals);

      // Template
      let tplRaw = getScriptText(def.tplId);
      // inject LONG prompt into YOU_ARE_* sentinel
      const longForJSON = prompt.replace(/`/g, '\\`').replace(/\n/g, '\\n');
      tplRaw = tplRaw.replace(/YOU_ARE_[A-Z_]+/g, longForJSON);
      // then inject placeholders everywhere
      tplRaw = injectPlaceholders(tplRaw, vals);

      return { prompt, tpl: tplRaw };
    }

    // Event delegation for agent actions
    document.addEventListener('click', (e)=>{
      const a = e.target.closest('[data-agent][data-action]');
      if(!a) return;
      e.preventDefault();
      const key = a.getAttribute('data-agent');
      const action = a.getAttribute('data-action');
      try{
        const { prompt, tpl } = buildAgent(key);
        if(action === 'build'){
          // Feedback only
          const msg = document.getElementById('agentsMsg');
          msg?.classList.remove('hidden');
          msg && setTimeout(()=>msg.classList.add('hidden'), 1500);
        } else if(action === 'prompt'){
          setDownload(a, `${key}-FULL-PROMPT.txt`, prompt, 'text/plain');
        } else if(action === 'json'){
          setDownload(a, `${key}-workflow.json`, JSON.stringify(JSON.parse(tpl), null, 2), 'application/json');
        }
      }catch(err){
        console.error(err);
        alert('Error: '+ err.message);
      }
    });

    // init
    function init(){ wireChat(); wireAudioUI(); loadVoices(); }
    if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', init); else init();
  })();
  </script>
</body>
</html>
